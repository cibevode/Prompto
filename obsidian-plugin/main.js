/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
"use strict";
var obsidian = require("obsidian");

// ═══ TYPES & CONSTANTS ═══════════════════════════════════

var VIEW_TYPE_PROMPTO = "prompto-library-view";

var DEFAULT_SETTINGS = {
	libraryPath: "Prompto Library",
	defaultRefiner: "grok",
	defaultSendTo: "grok",
	grokApiKey: "",
	claudeApiKey: "",
	openaiApiKey: "",
	veniceApiKey: "",
	veniceModel: "llama-3.3-70b",
	ollamaUrl: "http://localhost:11434",
	ollamaModel: "llama3",
	autoDetectContext: true,
	autoAdapt: true,
	generateIndex: true,
	autoExportJson: true,
	maxContextChars: 4000,
};

var CATEGORIES = [
	{ label: "All", icon: "layout-grid" },
	{ label: "Writing", icon: "pen-tool" },
	{ label: "Coding", icon: "code-2" },
	{ label: "Research", icon: "search" },
	{ label: "Product", icon: "package" },
	{ label: "Daily", icon: "calendar" },
	{ label: "Favorites", icon: "flag" },
];

var PROVIDER_NAMES = {
	grok: "Grok (xAI)",
	claude: "Claude",
	openai: "GPT-4o",
	venice: "Venice.ai",
	ollama: "Ollama",
};

var PROVIDER_ICONS = {
	grok: "zap",
	claude: "brain",
	openai: "sparkles",
	venice: "circle-dot",
	ollama: "hard-drive",
};

var PROMPT_TEMPLATE = '---\nname: "{{name}}"\ncategory: General\ntags: []\nversion: 1\neffectiveness: 0\nlastUsed: ""\nicon: "file-text"\nfavorite: false\n---\nWrite your prompt here.\n\nYou can use {{variables}} like this — Prompto will auto-detect them.\nThe special variable {{selected_text}} is automatically filled with any text you highlight in the editor.\n';

// ═══ FRONTMATTER UTILS ══════════════════════════════════

async function parsePromptFile(app, file) {
	try {
		var raw = await app.vault.read(file);
		var content = raw.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
		var match = content.match(/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/);
		if (!match) return null;
		var fmRaw = match[1], body = match[2].trim();
		var fm = {};
		fmRaw.split("\n").forEach(function(line) {
			var idx = line.indexOf(":");
			if (idx === -1) return;
			var key = line.slice(0, idx).trim();
			var val = line.slice(idx + 1).trim();
			if (val.startsWith("[") && val.endsWith("]")) {
				fm[key] = val.slice(1, -1).split(",").map(function(s) { return s.trim().replace(/^["']|["']$/g, ""); }).filter(Boolean);
			} else if (val === "true") { fm[key] = true; }
			else if (val === "false") { fm[key] = false; }
			else { fm[key] = val.replace(/^["']|["']$/g, ""); }
		});
		if (!fm["name"]) return null;
		// Auto-detect variables from {{var}} patterns
		var varMatches = body.match(/\{\{(\w+)\}\}/g) || [];
		var autoVars = [];
		varMatches.forEach(function(m) {
			var v = m.slice(2, -2);
			if (autoVars.indexOf(v) === -1) autoVars.push(v);
		});
		return {
			name: fm["name"],
			category: fm["category"] || "General",
			tags: Array.isArray(fm["tags"]) ? fm["tags"] : [],
			variables: autoVars,
			version: parseInt(fm["version"]) || 1,
			effectiveness: parseFloat(fm["effectiveness"]) || 0,
			lastUsed: fm["lastUsed"] || "",
			icon: fm["icon"] || "file-text",
			favorite: fm["favorite"] === true || fm["favorite"] === "true",
			path: file.path,
			body: body,
		};
	} catch (e) { console.error("Prompto: Error parsing " + file.path, e); return null; }
}

async function updateFrontmatterField(app, filePath, field, value) {
	var file = app.vault.getAbstractFileByPath(filePath);
	if (!(file instanceof obsidian.TFile)) return;
	var raw = await app.vault.read(file);
	var content = raw.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
	var strVal = typeof value === "boolean" ? String(value) : typeof value === "number" ? String(value) : '"' + value + '"';
	var re = new RegExp("^(" + field + ":\\s*)(.*)$", "m");
	if (re.test(content)) { content = content.replace(re, "$1" + strVal); }
	else { content = content.replace(/^(---\n)/, "$1" + field + ": " + strVal + "\n"); }
	await app.vault.modify(file, content);
}

function generateIndexContent(prompts) {
	var cats = {};
	prompts.forEach(function(p) { cats[p.category] = (cats[p.category] || 0) + 1; });
	var totalEff = 0, rated = 0;
	for (var i = 0; i < prompts.length; i++) {
		if (prompts[i].effectiveness > 0) { totalEff += prompts[i].effectiveness; rated++; }
	}
	var avgEff = rated > 0 ? (totalEff / rated).toFixed(1) : "N/A";
	var top = prompts.filter(function(p) { return p.effectiveness > 0; }).sort(function(a, b) { return b.effectiveness - a.effectiveness; }).slice(0, 5);
	var md = "---\ntags: [prompto, index, auto-generated]\n---\n# Prompto Library Index\n\n> Auto-generated by Prompto. Do not edit.\n\n## Stats\n\n";
	md += "| Total prompts | " + prompts.length + " |\n| Average effectiveness | " + avgEff + " \u2B50 |\n| Categories | " + Object.keys(cats).length + " |\n\n";
	md += "## Categories\n\n";
	for (var c in cats) md += "- **" + c + "** \u2014 " + cats[c] + " prompt" + (cats[c] > 1 ? "s" : "") + "\n";
	if (top.length > 0) { md += "\n## Top Rated\n\n"; top.forEach(function(p) { md += "- **" + p.name + "** \u2014 " + p.effectiveness + " \u2B50 (" + p.category + ")\n"; }); }
	md += "\n## All Prompts\n\n";
	prompts.sort(function(a, b) { return a.name.localeCompare(b.name); }).forEach(function(p) { md += "- [[" + p.name + "]] \u2014 " + p.category + (p.tags.length > 0 ? " \u00B7 " + p.tags.join(", ") : "") + "\n"; });
	return md;
}

// ═══ CONTEXT GATHERING ══════════════════════════════════

function gatherContext(app, maxChars) {
	var ctx = { selectedText: "", activeNoteContent: "", activeNoteTitle: "", activeNotePath: "", backlinks: [], recentNotes: [], activeNoteSummary: "" };
	var view = app.workspace.getActiveViewOfType(obsidian.MarkdownView);
	if (!view) {
		var leaves = app.workspace.getLeavesOfType("markdown");
		for (var li = 0; li < leaves.length; li++) {
			if (leaves[li].view instanceof obsidian.MarkdownView) { view = leaves[li].view; break; }
		}
	}
	if (view) {
		ctx.selectedText = view.editor.getSelection() || "";
		var file = view.file;
		if (file) {
			ctx.activeNoteTitle = file.basename;
			ctx.activeNotePath = file.path;
			var c = view.editor.getValue();
			ctx.activeNoteContent = c.slice(0, maxChars);
			ctx.activeNoteSummary = c.slice(0, 500);
			var allLinks = app.metadataCache.resolvedLinks;
			for (var sp in allLinks) {
				if (allLinks[sp][file.path] > 0) {
					var sf = app.vault.getAbstractFileByPath(sp);
					if (sf instanceof obsidian.TFile) ctx.backlinks.push(sf.basename);
				}
			}
			ctx.backlinks = ctx.backlinks.slice(0, 10);
		}
	}
	var recent = [];
	app.workspace.iterateAllLeaves(function(leaf) {
		if (leaf.view instanceof obsidian.MarkdownView && leaf.view.file) {
			var t = leaf.view.file.basename;
			if (recent.indexOf(t) === -1) recent.push(t);
		}
	});
	ctx.recentNotes = recent.slice(0, 5);
	return ctx;
}

function formatContextForRefiner(ctx) {
	var parts = [];
	if (ctx.selectedText) parts.push("## Selected Text\n" + ctx.selectedText);
	if (ctx.activeNoteTitle) parts.push('## Active Note: "' + ctx.activeNoteTitle + '" (' + ctx.activeNotePath + ")");
	if (ctx.activeNoteSummary) parts.push("## Note Summary\n" + ctx.activeNoteSummary);
	if (ctx.backlinks.length > 0) parts.push("## Backlinks\n" + ctx.backlinks.join(", "));
	if (ctx.recentNotes.length > 0) parts.push("## Recent Notes\n" + ctx.recentNotes.join(", "));
	return parts.join("\n\n");
}

function fillVariables(body, vals) {
	return body.replace(/\{\{(\w+)\}\}/g, function(m, k) { return vals[k] !== undefined && vals[k] !== "" ? vals[k] : m; });
}

function isProviderConfigured(provider, settings) {
	if (provider === "grok") return !!settings.grokApiKey;
	if (provider === "claude") return !!settings.claudeApiKey;
	if (provider === "openai") return !!settings.openaiApiKey;
	if (provider === "venice") return !!settings.veniceApiKey;
	if (provider === "ollama") return true;
	return false;
}

// ═══ LLM API CALLS ══════════════════════════════════════

async function callLLM(provider, systemPrompt, userPrompt, settings) {
	if (provider === "grok") {
		var resp = await obsidian.requestUrl({ url: "https://api.x.ai/v1/chat/completions", method: "POST",
			headers: { "Content-Type": "application/json", Authorization: "Bearer " + settings.grokApiKey },
			body: JSON.stringify({ model: "grok-3-mini-fast", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], temperature: 0.7 }) });
		return resp.json.choices[0].message.content;
	} else if (provider === "claude") {
		var resp = await obsidian.requestUrl({ url: "https://api.anthropic.com/v1/messages", method: "POST",
			headers: { "Content-Type": "application/json", "x-api-key": settings.claudeApiKey, "anthropic-version": "2023-06-01" },
			body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 4096, system: systemPrompt, messages: [{ role: "user", content: userPrompt }] }) });
		return resp.json.content[0].text;
	} else if (provider === "openai") {
		var resp = await obsidian.requestUrl({ url: "https://api.openai.com/v1/chat/completions", method: "POST",
			headers: { "Content-Type": "application/json", Authorization: "Bearer " + settings.openaiApiKey },
			body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], temperature: 0.7 }) });
		return resp.json.choices[0].message.content;
	} else if (provider === "venice") {
		var resp = await obsidian.requestUrl({ url: "https://api.venice.ai/api/v1/chat/completions", method: "POST",
			headers: { "Content-Type": "application/json", Authorization: "Bearer " + settings.veniceApiKey },
			body: JSON.stringify({ model: settings.veniceModel || "llama-3.3-70b", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], temperature: 0.7 }) });
		return resp.json.choices[0].message.content;
	} else if (provider === "ollama") {
		var resp = await obsidian.requestUrl({ url: (settings.ollamaUrl || "http://localhost:11434") + "/api/chat", method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ model: settings.ollamaModel || "llama3", messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }], stream: false }) });
		return resp.json.message.content;
	}
	throw new Error("Unknown provider: " + provider);
}

async function sendToLLM(provider, systemPrompt, userPrompt, settings) {
	return await callLLM(provider, systemPrompt, userPrompt, settings);
}

// ═══ ADAPTER (REFINER) ══════════════════════════════════

async function adaptPrompt(prompt, filledBody, contextStr, settings) {
	var sys = "You are a prompt engineering expert. Your job is to take a prompt template and adapt it using the provided context. Preserve the original intent and structure. Weave in relevant details from the context naturally. Return ONLY the adapted prompt text, nothing else.";
	var user = "## Original Prompt\n" + filledBody + "\n\n## Context\n" + contextStr + "\n\nAdapt the prompt above using the context. Return only the adapted prompt.";
	var result = await callLLM(settings.defaultRefiner, sys, user, settings);
	return { adaptedPrompt: result, adaptationNotes: "Adapted with " + PROVIDER_NAMES[settings.defaultRefiner] };
}

// ═══ RESPONSE MODAL ═════════════════════════════════════

class ResponseModal extends obsidian.Modal {
	constructor(app, prompt, response, providerName) {
		super(app); this.prompt = prompt; this.response = response; this.providerName = providerName;
	}
	onOpen() {
		var self = this, el = this.contentEl;
		el.empty(); el.addClass("prompto-response-modal");
		if (this.modalEl) { this.modalEl.style.maxWidth = "900px"; this.modalEl.style.width = "90vw"; }
		var hdr = el.createDiv({ cls: "prompto-response-header" });
		obsidian.setIcon(hdr.createSpan({ cls: "prompto-header-icon" }), PROVIDER_ICONS[this.providerName.toLowerCase()] || "message-circle");
		hdr.createEl("h2", { text: "Response from " + this.providerName });
		var cd = el.createDiv({ cls: "prompto-response-content" });
		obsidian.MarkdownRenderer.render(this.app, this.response, cd, "", this);
		var actions = el.createDiv({ cls: "prompto-response-actions" });
		var copyBtn = actions.createEl("button", { cls: "prompto-btn prompto-btn-primary" });
		obsidian.setIcon(copyBtn.createSpan(), "copy"); copyBtn.createSpan({ text: " Copy Response" });
		copyBtn.addEventListener("click", function() { navigator.clipboard.writeText(self.response); new obsidian.Notice("Copied!"); });
		var insertBtn = actions.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(insertBtn.createSpan(), "file-input"); insertBtn.createSpan({ text: " Insert into Note" });
		insertBtn.addEventListener("click", function() {
			var v = self.app.workspace.getActiveViewOfType(obsidian.MarkdownView);
			if (!v) {
				var leaves = self.app.workspace.getLeavesOfType("markdown");
				for (var i = 0; i < leaves.length; i++) { if (leaves[i].view instanceof obsidian.MarkdownView) { v = leaves[i].view; break; } }
			}
			if (v) { v.editor.replaceSelection(self.response); new obsidian.Notice("Inserted!"); self.close(); }
			else new obsidian.Notice("No active editor.");
		});
		// Rating
		var rs = el.createDiv({ cls: "prompto-rating-section" });
		rs.createEl("h3", { text: "Rate this prompt's effectiveness" });
		var sc = rs.createDiv({ cls: "prompto-stars" });
		for (var i = 1; i <= 5; i++) {
			var star = sc.createEl("button", { cls: "prompto-star-btn" });
			obsidian.setIcon(star, "star");
			star.style.opacity = i <= Math.round(this.prompt.effectiveness) ? "1" : "0.3";
			(function(rating) { star.addEventListener("click", async function() {
				var oldE = self.prompt.effectiveness || rating;
				var newE = Math.round(((oldE + rating) / 2) * 10) / 10;
				await updateFrontmatterField(self.app, self.prompt.path, "effectiveness", newE);
				self.prompt.effectiveness = newE;
				new obsidian.Notice("Rated " + rating + " \u2B50 — updated to " + newE);
				sc.querySelectorAll(".prompto-star-btn").forEach(function(s, idx) { s.style.opacity = idx < rating ? "1" : "0.3"; });
			}); })(i);
		}
	}
	onClose() { this.contentEl.empty(); }
}

// ═══ PREVIEW MODAL ══════════════════════════════════════

class PreviewModal extends obsidian.Modal {
	constructor(app, prompt, settings) {
		super(app); this.prompt = prompt; this.settings = settings;
		this.variableValues = {}; this.adaptedPrompt = prompt.body; this.leftPane = null; this.isAdapting = false;
		this.context = settings.autoDetectContext ? gatherContext(app, settings.maxContextChars)
			: { selectedText: "", activeNoteContent: "", activeNoteTitle: "", activeNotePath: "", backlinks: [], recentNotes: [], activeNoteSummary: "" };
		for (var vi = 0; vi < prompt.variables.length; vi++) {
			var v = prompt.variables[vi];
			this.variableValues[v] = (v === "selected_text" && this.context.selectedText) ? this.context.selectedText : "";
		}
	}
	async onOpen() {
		var self = this, el = this.contentEl;
		el.empty(); el.addClass("prompto-preview-modal");
		if (this.modalEl) {
			this.modalEl.style.maxWidth = "900px";
			this.modalEl.style.width = "90vw";
			this.modalEl.style.overflow = "hidden";
		}
		// Title
		var tb = el.createDiv({ cls: "prompto-modal-titlebar" });
		obsidian.setIcon(tb.createSpan({ cls: "prompto-modal-icon" }), this.prompt.icon || "file-text");
		tb.createEl("h2", { text: this.prompt.name });
		tb.createSpan({ cls: "prompto-category-badge", text: this.prompt.category });
		// Columns
		var cols = el.createDiv({ cls: "prompto-columns" });
		this.leftPane = cols.createDiv({ cls: "prompto-col-left" });
		var rp = cols.createDiv({ cls: "prompto-col-right" });
		// Context
		rp.createEl("h3", { text: "Detected Context" });
		var cs = rp.createDiv({ cls: "prompto-context-summary" });
		if (this.context.activeNoteTitle) cs.createEl("div", { cls: "prompto-ctx-item", text: "\uD83D\uDCC4 " + this.context.activeNoteTitle });
		if (this.context.selectedText) cs.createEl("div", { cls: "prompto-ctx-item", text: "\u2702\uFE0F Selection: " + this.context.selectedText.slice(0, 80) + (this.context.selectedText.length > 80 ? "\u2026" : "") });
		if (this.context.backlinks.length > 0) cs.createEl("div", { cls: "prompto-ctx-item", text: "\uD83D\uDD17 Backlinks: " + this.context.backlinks.slice(0, 3).join(", ") });
		if (!this.context.activeNoteTitle && !this.context.selectedText && this.context.backlinks.length === 0)
			cs.createEl("div", { cls: "prompto-ctx-item prompto-ctx-empty", text: "No context detected. Open a note or select text." });
		// Actions
		var ad = rp.createDiv({ cls: "prompto-actions" });
		var ab = ad.createEl("button", { cls: "prompto-btn prompto-btn-adapt" });
		obsidian.setIcon(ab.createSpan(), "wand-2");
		var at = ab.createSpan({ text: " Adapt with AI" });
		ab.addEventListener("click", function() { self.runAdaptation(ab, at); });
		var cpb = ad.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(cpb.createSpan(), "copy"); cpb.createSpan({ text: " Copy Prompt" });
		cpb.addEventListener("click", function() { navigator.clipboard.writeText(self.adaptedPrompt); new obsidian.Notice("Copied!"); });
		var inb = ad.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(inb.createSpan(), "file-input"); inb.createSpan({ text: " Insert into Note" });
		inb.addEventListener("click", function() {
			var mv = self.app.workspace.getActiveViewOfType(obsidian.MarkdownView);
			if (!mv) {
				var leaves = self.app.workspace.getLeavesOfType("markdown");
				for (var i = 0; i < leaves.length; i++) { if (leaves[i].view instanceof obsidian.MarkdownView) { mv = leaves[i].view; break; } }
			}
			if (mv) { mv.editor.replaceSelection(self.adaptedPrompt); new obsidian.Notice("Inserted!"); self.close(); }
			else new obsidian.Notice("No active editor.");
		});
		// Send buttons
		rp.createEl("h3", { text: "Send to LLM" });
		var sd = rp.createDiv({ cls: "prompto-send-buttons" });
		var providers = ["grok", "claude", "openai", "venice", "ollama"];
		for (var pi = 0; pi < providers.length; pi++) {
			var p = providers[pi], cfg = isProviderConfigured(p, this.settings);
			var btn = sd.createEl("button", { cls: "prompto-btn prompto-send-btn" + (!cfg ? " prompto-btn-disabled" : "") });
			obsidian.setIcon(btn.createSpan(), PROVIDER_ICONS[p]);
			btn.createSpan({ text: " " + PROVIDER_NAMES[p] });
			if (!cfg) btn.title = "Not configured";
			(function(prov, button) { button.addEventListener("click", async function() {
				if (!isProviderConfigured(prov, self.settings)) { new obsidian.Notice(PROVIDER_NAMES[prov] + " not configured."); return; }
				await self.sendToProvider(prov, button);
			}); })(p, btn);
		}
		this.renderLeftPane();
		if (this.settings.autoAdapt && isProviderConfigured(this.settings.defaultRefiner, this.settings))
			await this.runAdaptation(ab, at);
	}
	renderLeftPane() {
		if (!this.leftPane) return;
		this.leftPane.empty();
		this.leftPane.createEl("h3", { text: "Prompt Preview" });
		var pd = this.leftPane.createDiv({ cls: "prompto-preview-content" });
		obsidian.MarkdownRenderer.render(this.app, fillVariables(this.adaptedPrompt, this.variableValues), pd, "", this);
	}
	async runAdaptation(btn, txt) {
		if (this.isAdapting) return; this.isAdapting = true;
		btn.addClass("prompto-btn-loading"); txt.setText(" Adapting...");
		try {
			var result = await adaptPrompt(this.prompt, fillVariables(this.prompt.body, this.variableValues), formatContextForRefiner(this.context), this.settings);
			this.adaptedPrompt = result.adaptedPrompt; this.renderLeftPane();
			new obsidian.Notice(result.adaptationNotes);
		} catch (e) { new obsidian.Notice("Adaptation failed: " + (e instanceof Error ? e.message : "Error")); }
		finally { this.isAdapting = false; btn.removeClass("prompto-btn-loading"); txt.setText(" Adapt with AI"); }
	}
	async sendToProvider(provider, btn) {
		btn.addClass("prompto-btn-loading");
		try {
			var fp = fillVariables(this.adaptedPrompt, this.variableValues);
			await updateFrontmatterField(this.app, this.prompt.path, "lastUsed", new Date().toISOString().slice(0, 10));
			var resp = await sendToLLM(provider, "You are a helpful, expert AI assistant.", fp, this.settings);
			this.close(); new ResponseModal(this.app, this.prompt, resp, PROVIDER_NAMES[provider]).open();
		} catch (e) { new obsidian.Notice("Send failed: " + (e instanceof Error ? e.message : "Error")); }
		finally { btn.removeClass("prompto-btn-loading"); }
	}
	onClose() { this.contentEl.empty(); }
}

// ═══ SIDEBAR VIEW ═══════════════════════════════════════

class PromptLibraryView extends obsidian.ItemView {
	constructor(leaf, plugin) {
		super(leaf); this.plugin = plugin;
		this.prompts = []; this.filteredPrompts = [];
		this.activeCategory = "All"; this.searchQuery = ""; this.cardsContainer = null;
	}
	getViewType() { return VIEW_TYPE_PROMPTO; }
	getDisplayText() { return "Prompto"; }
	getIcon() { return "target"; }
	async onOpen() { await this.loadPrompts(); this.buildUI(); }
	async onClose() { this.contentEl.empty(); }

	async loadPrompts() {
		this.prompts = [];
		var folder = this.app.vault.getAbstractFileByPath(this.plugin.settings.libraryPath);
		if (!(folder instanceof obsidian.TFolder)) return;
		for (var i = 0; i < folder.children.length; i++) {
			var child = folder.children[i];
			if (child instanceof obsidian.TFile && child.extension === "md" && !child.basename.startsWith("_")) {
				var pf = await parsePromptFile(this.app, child);
				if (pf) this.prompts.push(pf);
			}
		}
		this.prompts.sort(function(a, b) {
			if (a.favorite && !b.favorite) return -1;
			if (!a.favorite && b.favorite) return 1;
			return b.effectiveness - a.effectiveness || a.name.localeCompare(b.name);
		});
		this.applyFilters();
	}

	applyFilters() {
		var self = this;
		this.filteredPrompts = this.prompts.filter(function(p) {
			if (self.activeCategory !== "All" && self.activeCategory !== "Favorites" && p.category !== self.activeCategory) return false;
			if (self.searchQuery) {
				var q = self.searchQuery.toLowerCase();
				return p.name.toLowerCase().indexOf(q) !== -1 || p.tags.some(function(t) { return t.toLowerCase().indexOf(q) !== -1; }) || p.category.toLowerCase().indexOf(q) !== -1 || p.body.toLowerCase().indexOf(q) !== -1;
			}
			return true;
		});
		if (self.activeCategory === "Favorites") {
			this.filteredPrompts.sort(function(a, b) {
				if (a.favorite && !b.favorite) return -1;
				if (!a.favorite && b.favorite) return 1;
				return b.effectiveness - a.effectiveness || a.name.localeCompare(b.name);
			});
		}
	}

	buildUI() {
		var self = this, el = this.contentEl;
		el.empty(); el.addClass("prompto-sidebar");
		var hd = el.createDiv({ cls: "prompto-sidebar-header" });
		var tr = hd.createDiv({ cls: "prompto-title-row" });
		obsidian.setIcon(tr.createSpan({ cls: "prompto-title-icon" }), "target");
		tr.createEl("h3", { text: "Prompto" });
		tr.createSpan({ cls: "prompto-count-badge", text: String(this.prompts.length) });

		// New Prompt — creates a note from template and opens in editor
		var newBtn = tr.createEl("button", { cls: "prompto-btn-new", title: "New prompt (creates note)" });
		obsidian.setIcon(newBtn, "plus");
		newBtn.addEventListener("click", async function() {
			var name = "New Prompt " + Date.now().toString(36);
			var fp = self.plugin.settings.libraryPath + "/" + name + ".md";
			await self.plugin.ensureLibraryFolder();
			var content = PROMPT_TEMPLATE.replace("{{name}}", name);
			var file = await self.app.vault.create(fp, content);
			await self.app.workspace.getLeaf(false).openFile(file);
			new obsidian.Notice("Edit your new prompt, then refresh Prompto.");
		});

		// Settings button
		var settingsBtn = tr.createEl("button", { cls: "prompto-btn-new prompto-btn-manage", title: "Prompto settings" });
		obsidian.setIcon(settingsBtn, "settings");
		settingsBtn.addEventListener("click", function() {
			self.app.setting.open();
			self.app.setting.openTabById("prompto");
		});

		// Search
		var sw = hd.createDiv({ cls: "prompto-search-wrap" });
		obsidian.setIcon(sw.createSpan({ cls: "prompto-search-icon" }), "search");
		var si = sw.createEl("input", { type: "text", placeholder: "Search prompts...", cls: "prompto-search-input" });
		si.addEventListener("input", function() { self.searchQuery = si.value; self.applyFilters(); self.renderCards(); });

		// Category filter row
		var filterRow = hd.createDiv({ cls: "prompto-filter-row" });

		var allBtn = filterRow.createEl("button", { cls: "prompto-filter-btn" + (this.activeCategory === "All" ? " prompto-filter-btn-active" : "") });
		obsidian.setIcon(allBtn.createSpan({ cls: "prompto-tab-icon" }), "layout-grid");
		allBtn.createSpan({ text: " All" });
		allBtn.addEventListener("click", function() {
			self.activeCategory = "All";
			allBtn.addClass("prompto-filter-btn-active");
			favBtn.removeClass("prompto-filter-btn-active");
			catSelect.value = "";
			self.applyFilters(); self.renderCards();
		});

		var favBtn = filterRow.createEl("button", { cls: "prompto-filter-btn" + (this.activeCategory === "Favorites" ? " prompto-filter-btn-active" : "") });
		obsidian.setIcon(favBtn.createSpan({ cls: "prompto-tab-icon" }), "flag");
		favBtn.createSpan({ text: " Favorites" });
		favBtn.addEventListener("click", function() {
			self.activeCategory = "Favorites";
			favBtn.addClass("prompto-filter-btn-active");
			allBtn.removeClass("prompto-filter-btn-active");
			catSelect.value = "";
			self.applyFilters(); self.renderCards();
		});

		// Category dropdown
		var catSelect = filterRow.createEl("select", { cls: "prompto-filter-select" });
		catSelect.createEl("option", { text: "Category...", attr: { value: "" } });
		var seenCats = {};
		for (var ci = 0; ci < this.prompts.length; ci++) {
			if (!seenCats[this.prompts[ci].category]) {
				catSelect.createEl("option", { text: this.prompts[ci].category, attr: { value: this.prompts[ci].category } });
				seenCats[this.prompts[ci].category] = true;
			}
		}
		var stdCats = ["Writing", "Coding", "Research", "Product", "Daily"];
		for (var sc = 0; sc < stdCats.length; sc++) {
			if (!seenCats[stdCats[sc]]) catSelect.createEl("option", { text: stdCats[sc], attr: { value: stdCats[sc] } });
		}
		if (this.activeCategory !== "All" && this.activeCategory !== "Favorites") catSelect.value = this.activeCategory;
		catSelect.addEventListener("change", function() {
			var v = catSelect.value;
			if (v) {
				self.activeCategory = v;
				allBtn.removeClass("prompto-filter-btn-active");
				favBtn.removeClass("prompto-filter-btn-active");
			} else {
				self.activeCategory = "All";
				allBtn.addClass("prompto-filter-btn-active");
			}
			self.applyFilters(); self.renderCards();
		});

		this.cardsContainer = el.createDiv({ cls: "prompto-cards" });
		this.renderCards();
	}

	renderCards() {
		if (!this.cardsContainer) return;
		this.cardsContainer.empty();
		if (this.filteredPrompts.length === 0) {
			var emp = this.cardsContainer.createDiv({ cls: "prompto-empty" });
			obsidian.setIcon(emp.createDiv({ cls: "prompto-empty-icon" }), "inbox");
			emp.createEl("p", { text: "No prompts found." });
			if (this.prompts.length === 0) emp.createEl("p", { text: 'Add .md files to your "' + this.plugin.settings.libraryPath + '" folder, or click + to create one.', cls: "prompto-empty-hint" });
			return;
		}
		for (var i = 0; i < this.filteredPrompts.length; i++) this.renderCard(this.filteredPrompts[i]);
	}

	renderCard(prompt) {
		if (!this.cardsContainer) return;
		var self = this;
		var card = this.cardsContainer.createDiv({ cls: "prompto-card" });
		card.addEventListener("click", function() { new PreviewModal(self.app, prompt, self.plugin.settings).open(); });
		var ch = card.createDiv({ cls: "prompto-card-header" });
		obsidian.setIcon(ch.createSpan({ cls: "prompto-card-icon" }), prompt.icon || "file-text");
		ch.createEl("span", { text: prompt.name, cls: "prompto-card-title" });
		var meta = card.createDiv({ cls: "prompto-card-meta" });
		meta.createSpan({ cls: "prompto-card-category", text: prompt.category });
		for (var ti = 0; ti < Math.min(prompt.tags.length, 3); ti++) meta.createSpan({ cls: "prompto-card-tag", text: prompt.tags[ti] });
		card.createDiv({ cls: "prompto-card-body", text: prompt.body.slice(0, 100).replace(/\n/g, " ") + (prompt.body.length > 100 ? "\u2026" : "") });
		var ft = card.createDiv({ cls: "prompto-card-footer" });
		if (prompt.lastUsed) ft.createSpan({ cls: "prompto-card-date", text: prompt.lastUsed });
		var copyBtn = ft.createEl("button", { cls: "prompto-card-copy-btn", title: "Copy prompt to clipboard" });
		obsidian.setIcon(copyBtn, "copy");
		copyBtn.addEventListener("click", function(e) {
			e.stopPropagation();
			navigator.clipboard.writeText(prompt.body).then(function() { new obsidian.Notice("Copied to clipboard!"); });
		});
		var fav = card.createDiv({ cls: "prompto-card-fav" });
		obsidian.setIcon(fav, prompt.favorite ? "flag" : "flag-off");
		fav.addEventListener("click", async function(e) {
			e.stopPropagation(); prompt.favorite = !prompt.favorite;
			await updateFrontmatterField(self.app, prompt.path, "favorite", prompt.favorite);
			self.prompts.sort(function(a, b) {
				if (a.favorite && !b.favorite) return -1;
				if (!a.favorite && b.favorite) return 1;
				return b.effectiveness - a.effectiveness || a.name.localeCompare(b.name);
			});
			self.applyFilters(); self.renderCards();
		});
		// Open in editor button
		var cardActions = card.createDiv({ cls: "prompto-card-actions" });
		var openBtn = cardActions.createEl("button", { cls: "prompto-card-action-btn", title: "Edit in Obsidian" });
		obsidian.setIcon(openBtn, "pencil");
		openBtn.addEventListener("click", function(e) {
			e.stopPropagation();
			var file = self.app.vault.getAbstractFileByPath(prompt.path);
			if (file instanceof obsidian.TFile) self.app.workspace.getLeaf(false).openFile(file);
		});
	}

	async refresh() { await this.loadPrompts(); this.buildUI(); }
}

// ═══ SETTINGS TAB ═══════════════════════════════════════

class PromptoSettingTab extends obsidian.PluginSettingTab {
	constructor(app, plugin) { super(app, plugin); this.plugin = plugin; }
	display() {
		var el = this.containerEl, p = this.plugin;
		el.empty();
		el.createEl("h1", { text: "Prompto Settings" });
		el.createEl("p", { text: "Configure your prompt library, API keys, and default behaviors.", cls: "setting-item-description" });

		el.createEl("h2", { text: "Library" });
		new obsidian.Setting(el).setName("Library folder path").setDesc("Vault-relative path where prompt files are stored. Created automatically if missing.")
			.addText(function(t) { t.setPlaceholder("Prompto Library").setValue(p.settings.libraryPath).onChange(async function(v) { p.settings.libraryPath = v || "Prompto Library"; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Generate index file").setDesc("Auto-generate _Prompto Index.md with library stats and links.")
			.addToggle(function(t) { t.setValue(p.settings.generateIndex).onChange(async function(v) { p.settings.generateIndex = v; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Auto-export JSON").setDesc("Auto-export prompto-library.json for use with Prompto Chrome Extension or other tools.")
			.addToggle(function(t) { t.setValue(p.settings.autoExportJson).onChange(async function(v) { p.settings.autoExportJson = v; await p.saveSettings(); }); });

		el.createEl("h2", { text: "API Keys" });
		el.createEl("p", { text: "Keys are stored locally in plugin data. Only configure providers you use.", cls: "setting-item-description" });

		new obsidian.Setting(el).setName("Grok / xAI API key").setDesc("Get yours at console.x.ai")
			.addText(function(t) { t.setPlaceholder("xai-...").setValue(p.settings.grokApiKey).onChange(async function(v) { p.settings.grokApiKey = v.trim(); await p.saveSettings(); }); t.inputEl.type = "password"; });
		new obsidian.Setting(el).setName("Claude / Anthropic API key").setDesc("Get yours at console.anthropic.com")
			.addText(function(t) { t.setPlaceholder("sk-ant-...").setValue(p.settings.claudeApiKey).onChange(async function(v) { p.settings.claudeApiKey = v.trim(); await p.saveSettings(); }); t.inputEl.type = "password"; });
		new obsidian.Setting(el).setName("OpenAI API key").setDesc("Get yours at platform.openai.com")
			.addText(function(t) { t.setPlaceholder("sk-...").setValue(p.settings.openaiApiKey).onChange(async function(v) { p.settings.openaiApiKey = v.trim(); await p.saveSettings(); }); t.inputEl.type = "password"; });
		new obsidian.Setting(el).setName("Venice.ai API key").setDesc("Get yours at venice.ai — privacy-first, OpenAI-compatible")
			.addText(function(t) { t.setPlaceholder("venice-...").setValue(p.settings.veniceApiKey).onChange(async function(v) { p.settings.veniceApiKey = v.trim(); await p.saveSettings(); }); t.inputEl.type = "password"; });
		new obsidian.Setting(el).setName("Venice.ai model").setDesc("Model name (e.g. llama-3.3-70b, deepseek-r1)")
			.addText(function(t) { t.setPlaceholder("llama-3.3-70b").setValue(p.settings.veniceModel).onChange(async function(v) { p.settings.veniceModel = v.trim() || "llama-3.3-70b"; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Ollama base URL").setDesc("Local Ollama instance URL")
			.addText(function(t) { t.setPlaceholder("http://localhost:11434").setValue(p.settings.ollamaUrl).onChange(async function(v) { p.settings.ollamaUrl = v.trim() || "http://localhost:11434"; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Ollama model").setDesc("Model name for Ollama")
			.addText(function(t) { t.setPlaceholder("llama3").setValue(p.settings.ollamaModel).onChange(async function(v) { p.settings.ollamaModel = v.trim() || "llama3"; await p.saveSettings(); }); });

		el.createEl("h2", { text: "Defaults" });
		var opts = { grok: "Grok (xAI)", claude: "Claude (Anthropic)", openai: "GPT-4o (OpenAI)", venice: "Venice.ai", ollama: "Ollama (Local)" };
		new obsidian.Setting(el).setName("Default refiner model").setDesc("Which LLM adapts your prompts with context.")
			.addDropdown(function(d) { d.addOptions(opts).setValue(p.settings.defaultRefiner).onChange(async function(v) { p.settings.defaultRefiner = v; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Default send-to model").setDesc("Default destination when you click Send.")
			.addDropdown(function(d) { d.addOptions(opts).setValue(p.settings.defaultSendTo).onChange(async function(v) { p.settings.defaultSendTo = v; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Auto-detect context").setDesc("Gather context from active note, selection, and backlinks.")
			.addToggle(function(t) { t.setValue(p.settings.autoDetectContext).onChange(async function(v) { p.settings.autoDetectContext = v; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Auto-adapt prompts").setDesc("Automatically run the refiner when opening a prompt card.")
			.addToggle(function(t) { t.setValue(p.settings.autoAdapt).onChange(async function(v) { p.settings.autoAdapt = v; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Max context characters").setDesc("Max chars of context sent to refiner.")
			.addText(function(t) { t.setPlaceholder("4000").setValue(String(p.settings.maxContextChars)).onChange(async function(v) { var n = parseInt(v, 10); p.settings.maxContextChars = isNaN(n) ? 4000 : n; await p.saveSettings(); }); });
	}
}

// ═══ MAIN PLUGIN ════════════════════════════════════════

class PromptoPlugin extends obsidian.Plugin {
	constructor() { super(...arguments); this.settings = Object.assign({}, DEFAULT_SETTINGS); }

	async onload() {
		console.log("Prompto: Loading...");
		await this.loadSettings();
		var self = this;
		this.registerView(VIEW_TYPE_PROMPTO, function(leaf) { return new PromptLibraryView(leaf, self); });
		this.injectStyles();
		this.addRibbonIcon("target", "Open Prompto Library", function() { self.activateView(); });
		this.addCommand({ id: "open-prompto-library", name: "Open Prompto Library", callback: function() { self.activateView(); } });
		this.addCommand({ id: "save-as-prompt", name: "Save current note as prompt", editorCallback: async function(editor) {
			var view = self.app.workspace.getActiveViewOfType(obsidian.MarkdownView); await self.saveCurrentAsPrompt(editor, view);
		}});
		this.addCommand({ id: "new-prompt", name: "New prompt from template", callback: async function() {
			var name = "New Prompt " + Date.now().toString(36);
			var fp = self.settings.libraryPath + "/" + name + ".md";
			await self.ensureLibraryFolder();
			var content = PROMPT_TEMPLATE.replace("{{name}}", name);
			var file = await self.app.vault.create(fp, content);
			await self.app.workspace.getLeaf(false).openFile(file);
			new obsidian.Notice("Edit your new prompt, then refresh Prompto.");
		}});
		this.addCommand({ id: "generate-prompto-index", name: "Generate Prompto Index", callback: function() { self.generateIndex(); } });
		this.addCommand({ id: "refresh-prompto-library", name: "Refresh Prompto Library", callback: async function() {
			await self.refreshView(); new obsidian.Notice("Prompto: Refreshed!");
		}});
		this.addCommand({ id: "export-prompto-json", name: "Export library as JSON", callback: async function() { await self.exportJson(); } });
		this.addSettingTab(new PromptoSettingTab(this.app, this));

		// File watcher — auto-refresh sidebar when prompt files change
		this.registerEvent(this.app.vault.on("modify", function(file) {
			if (file instanceof obsidian.TFile && file.path.startsWith(self.settings.libraryPath)) {
				clearTimeout(self._refreshTimer);
				self._refreshTimer = setTimeout(function() { self.refreshView(); if (self.settings.autoExportJson) self.exportJson(); }, 1000);
			}
		}));
		this.registerEvent(this.app.vault.on("create", function(file) {
			if (file instanceof obsidian.TFile && file.path.startsWith(self.settings.libraryPath)) {
				clearTimeout(self._refreshTimer);
				self._refreshTimer = setTimeout(function() { self.refreshView(); if (self.settings.autoExportJson) self.exportJson(); }, 1000);
			}
		}));
		this.registerEvent(this.app.vault.on("delete", function(file) {
			if (file instanceof obsidian.TFile && file.path.startsWith(self.settings.libraryPath)) {
				clearTimeout(self._refreshTimer);
				self._refreshTimer = setTimeout(function() { self.refreshView(); if (self.settings.autoExportJson) self.exportJson(); }, 1000);
			}
		}));
		this.registerEvent(this.app.vault.on("rename", function(file) {
			if (file instanceof obsidian.TFile && file.path.startsWith(self.settings.libraryPath)) {
				clearTimeout(self._refreshTimer);
				self._refreshTimer = setTimeout(function() { self.refreshView(); if (self.settings.autoExportJson) self.exportJson(); }, 1000);
			}
		}));

		this.app.workspace.onLayoutReady(async function() {
			await self.ensureLibraryFolder();
			if (self.settings.generateIndex) await self.generateIndex();
			if (self.settings.autoExportJson) await self.exportJson();
			console.log("Prompto: Ready!");
		});
	}

	onunload() { this.app.workspace.detachLeavesOfType(VIEW_TYPE_PROMPTO); }

	async activateView() {
		var leaves = this.app.workspace.getLeavesOfType(VIEW_TYPE_PROMPTO);
		if (leaves.length > 0) { this.app.workspace.revealLeaf(leaves[0]); return; }
		var rl = this.app.workspace.getRightLeaf(false);
		if (rl) { await rl.setViewState({ type: VIEW_TYPE_PROMPTO, active: true }); this.app.workspace.revealLeaf(rl); }
	}

	async ensureLibraryFolder() {
		if (!this.app.vault.getAbstractFileByPath(this.settings.libraryPath)) {
			await this.app.vault.createFolder(this.settings.libraryPath);
			new obsidian.Notice('Prompto: Created "' + this.settings.libraryPath + '"');
		}
	}

	async saveCurrentAsPrompt(editor, view) {
		var text = editor.getSelection() || editor.getValue();
		var title = (view && view.file) ? view.file.basename : "New Prompt";
		var fp = this.settings.libraryPath + "/" + title + ".md";
		if (this.app.vault.getAbstractFileByPath(fp)) { new obsidian.Notice('"' + title + '" already exists in library.'); return; }
		await this.ensureLibraryFolder();
		var fm = "---\nname: \"" + title + "\"\ncategory: General\ntags: []\nversion: 1\neffectiveness: 0\nlastUsed: \"" + new Date().toISOString().slice(0, 10) + "\"\nicon: \"file-text\"\nfavorite: false\n---";
		await this.app.vault.create(fp, fm + "\n\n" + text);
		new obsidian.Notice('Saved "' + title + '" to Prompto Library!');
	}

	async generateIndex() {
		var folder = this.app.vault.getAbstractFileByPath(this.settings.libraryPath);
		if (!(folder instanceof obsidian.TFolder)) return;
		var prompts = [];
		for (var i = 0; i < folder.children.length; i++) {
			var c = folder.children[i];
			if (c instanceof obsidian.TFile && c.extension === "md" && !c.basename.startsWith("_")) { var pf = await parsePromptFile(this.app, c); if (pf) prompts.push(pf); }
		}
		var content = generateIndexContent(prompts);
		var ip = this.settings.libraryPath + "/_Prompto Index.md";
		var ex = this.app.vault.getAbstractFileByPath(ip);
		if (ex instanceof obsidian.TFile) await this.app.vault.modify(ex, content);
		else await this.app.vault.create(ip, content);
	}

	async exportJson() {
		var folder = this.app.vault.getAbstractFileByPath(this.settings.libraryPath);
		if (!(folder instanceof obsidian.TFolder)) return;
		var prompts = [];
		for (var i = 0; i < folder.children.length; i++) {
			var c = folder.children[i];
			if (c instanceof obsidian.TFile && c.extension === "md" && !c.basename.startsWith("_")) {
				var pf = await parsePromptFile(this.app, c);
				if (pf) prompts.push(pf);
			}
		}
		var data = { version: 1, exported: new Date().toISOString(), count: prompts.length, prompts: prompts.map(function(p) {
			return { name: p.name, category: p.category, tags: p.tags, variables: p.variables, effectiveness: p.effectiveness, lastUsed: p.lastUsed, icon: p.icon, favorite: p.favorite, body: p.body };
		})};
		var json = JSON.stringify(data, null, 2);
		var jp = this.settings.libraryPath + "/prompto-library.json";
		var ex = this.app.vault.getAbstractFileByPath(jp);
		if (ex instanceof obsidian.TFile) await this.app.vault.modify(ex, json);
		else await this.app.vault.create(jp, json);
	}

	async refreshView() {
		var leaves = this.app.workspace.getLeavesOfType(VIEW_TYPE_PROMPTO);
		for (var i = 0; i < leaves.length; i++) if (leaves[i].view instanceof PromptLibraryView) await leaves[i].view.refresh();
	}

	async loadSettings() { this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData()); }
	async saveSettings() { await this.saveData(this.settings); }

	injectStyles() {
		var css = ".prompto-sidebar{padding:0;height:100%;display:flex;flex-direction:column;overflow:hidden}.prompto-sidebar-header{padding:12px 12px 8px;border-bottom:1px solid var(--background-modifier-border);flex-shrink:0}.prompto-title-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}.prompto-title-row h3{margin:0;font-size:16px;font-weight:600}.prompto-title-icon{display:flex;align-items:center}.prompto-title-icon svg{width:18px;height:18px;color:var(--text-accent)}.prompto-count-badge{background:var(--interactive-accent);color:var(--text-on-accent);padding:1px 7px;border-radius:10px;font-size:11px;font-weight:600;margin-left:auto}.prompto-search-wrap{display:flex;align-items:center;background:var(--background-secondary);border-radius:6px;padding:4px 8px;margin-bottom:8px}.prompto-search-icon{display:flex;margin-right:6px}.prompto-search-icon svg{width:14px;height:14px;color:var(--text-muted)}.prompto-search-input{border:none;background:transparent;width:100%;font-size:13px;color:var(--text-normal);outline:none}.prompto-search-input::placeholder{color:var(--text-faint)}.prompto-filter-row{display:flex;align-items:center;gap:6px;padding-bottom:4px}.prompto-filter-btn{display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;border:1px solid var(--background-modifier-border);background:var(--background-secondary);color:var(--text-muted);font-size:12px;cursor:pointer;white-space:nowrap;transition:background .15s,color .15s,border-color .15s}.prompto-filter-btn:hover{background:var(--background-modifier-hover);color:var(--text-normal)}.prompto-filter-btn-active{background:var(--interactive-accent)!important;color:var(--text-on-accent)!important;border-color:var(--interactive-accent)!important}.prompto-filter-select{padding:5px 8px;font-size:12px;border-radius:6px;border:1px solid var(--background-modifier-border);background:var(--background-secondary);color:var(--text-normal);cursor:pointer;outline:none;height:30px}.prompto-cards{flex:1;overflow-y:auto;padding:8px 12px;display:flex;flex-direction:column;gap:8px}.prompto-card{background:var(--background-secondary);border:1px solid var(--background-modifier-border);border-radius:8px;padding:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s;position:relative}.prompto-card:hover{border-color:var(--interactive-accent);box-shadow:0 2px 8px rgba(0,0,0,.08)}.prompto-card-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}.prompto-card-icon{display:flex;flex-shrink:0}.prompto-card-icon svg{width:16px;height:16px;color:var(--text-accent)}.prompto-card-title{font-weight:600;font-size:13px;color:var(--text-normal);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.prompto-card-meta{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px}.prompto-card-category{background:var(--interactive-accent);color:var(--text-on-accent);padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600}.prompto-card-tag{background:var(--background-modifier-border);color:var(--text-muted);padding:1px 6px;border-radius:4px;font-size:10px}.prompto-card-body{font-size:12px;color:var(--text-muted);line-height:1.4;margin-bottom:6px}.prompto-card-footer{display:flex;justify-content:space-between;align-items:center}.prompto-card-date{font-size:10px;color:var(--text-faint)}.prompto-card-copy-btn{display:flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:4px;border:none;background:var(--background-modifier-border);color:var(--text-muted);cursor:pointer;padding:0;margin-left:auto;opacity:0;transition:opacity .15s,background .15s}.prompto-card:hover .prompto-card-copy-btn{opacity:1}.prompto-card-copy-btn:hover{background:var(--interactive-accent);color:var(--text-on-accent)}.prompto-card-copy-btn svg{width:12px;height:12px}.prompto-card-fav{position:absolute;top:8px;right:8px;cursor:pointer;display:flex}.prompto-card-fav svg{width:14px;height:14px;color:var(--text-accent)}.prompto-card-actions{display:flex;gap:4px;position:absolute;top:8px;right:30px}.prompto-card-action-btn{display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:4px;border:none;background:var(--background-modifier-border);color:var(--text-muted);cursor:pointer;padding:0;opacity:0;transition:opacity .15s}.prompto-card:hover .prompto-card-action-btn{opacity:1}.prompto-card-action-btn:hover{background:var(--interactive-accent);color:var(--text-on-accent)}.prompto-card-action-btn svg{width:12px;height:12px}.prompto-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:var(--text-muted)}.prompto-empty-icon svg{width:40px;height:40px;color:var(--text-faint)}.prompto-empty p{margin:8px 0 0;font-size:13px}.prompto-empty-hint{font-size:11px;color:var(--text-faint)}.prompto-preview-modal{max-width:900px!important;width:90vw!important;overflow:hidden!important}.prompto-modal-titlebar{display:flex;align-items:center;gap:10px;margin-bottom:16px;border-bottom:1px solid var(--background-modifier-border);padding-bottom:12px}.prompto-modal-titlebar h2{margin:0;font-size:18px}.prompto-modal-icon{display:flex}.prompto-modal-icon svg{width:22px;height:22px;color:var(--text-accent)}.prompto-category-badge{background:var(--interactive-accent);color:var(--text-on-accent);padding:2px 10px;border-radius:12px;font-size:11px;font-weight:600}.prompto-columns{display:flex;gap:16px;min-height:300px}.prompto-col-left{flex:1;border-right:1px solid var(--background-modifier-border);padding-right:16px;overflow-y:auto;overflow-x:hidden;max-height:70vh}.prompto-col-right{width:240px;flex-shrink:0;overflow-y:auto;max-height:70vh}.prompto-col-left h3,.prompto-col-right h3{font-size:13px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin:0 0 10px}.prompto-preview-content{font-size:14px;line-height:1.6}.prompto-context-summary{background:var(--background-secondary);border-radius:6px;padding:10px;margin-bottom:16px}.prompto-ctx-item{font-size:12px;color:var(--text-normal);margin-bottom:4px;line-height:1.4}.prompto-ctx-empty{color:var(--text-faint);font-style:italic}.prompto-actions{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}.prompto-btn{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:6px;border:1px solid var(--background-modifier-border);background:var(--background-secondary);color:var(--text-normal);font-size:13px;cursor:pointer;transition:background .15s,border-color .15s}.prompto-btn:hover{background:var(--background-modifier-hover);border-color:var(--interactive-accent)}.prompto-btn svg{width:14px;height:14px}.prompto-btn-primary,.prompto-btn-adapt{background:var(--interactive-accent);color:var(--text-on-accent);border-color:var(--interactive-accent)}.prompto-btn-primary:hover,.prompto-btn-adapt:hover{opacity:.9}.prompto-btn-loading{opacity:.6;pointer-events:none}.prompto-btn-disabled{opacity:.4;cursor:not-allowed}.prompto-send-buttons{display:grid;grid-template-columns:1fr 1fr;gap:6px}.prompto-send-btn{font-size:11px;padding:6px 6px;justify-content:center}.prompto-response-modal{max-width:900px;width:90vw}.prompto-response-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}.prompto-response-header h2{margin:0}.prompto-header-icon{display:inline-flex;margin-right:4px}.prompto-header-icon svg{width:20px;height:20px}.prompto-response-content{background:var(--background-secondary);border-radius:8px;padding:16px;max-height:50vh;overflow-y:auto;margin-bottom:16px;font-size:14px;line-height:1.6}.prompto-response-actions{display:flex;gap:8px;margin-bottom:16px}.prompto-rating-section{text-align:center}.prompto-rating-section h3{font-size:14px;margin-bottom:8px}.prompto-stars{display:flex;justify-content:center;gap:8px}.prompto-star-btn{background:none;border:none;cursor:pointer;padding:4px;transition:transform .15s}.prompto-star-btn:hover{transform:scale(1.3)}.prompto-star-btn svg{width:24px;height:24px;color:var(--text-accent)}.prompto-btn-new{display:flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;border:1px solid var(--background-modifier-border);background:var(--interactive-accent);color:var(--text-on-accent);cursor:pointer;padding:0;margin-left:4px;transition:opacity .15s}.prompto-btn-new:hover{opacity:.85}.prompto-btn-new svg{width:14px;height:14px}.prompto-btn-manage{background:var(--background-secondary);color:var(--text-muted);border-color:var(--background-modifier-border)}.prompto-btn-manage:hover{color:var(--text-normal);border-color:var(--interactive-accent)}@media(max-width:600px){.prompto-columns{flex-direction:column}.prompto-col-left{border-right:none;border-bottom:1px solid var(--background-modifier-border);padding-right:0;padding-bottom:16px;max-height:40vh}.prompto-col-right{width:100%}.prompto-send-buttons{grid-template-columns:1fr}.prompto-preview-modal,.prompto-response-modal{width:95vw}}";
		var styleEl = document.createElement("style");
		styleEl.id = "prompto-styles";
		styleEl.textContent = css;
		document.head.appendChild(styleEl);
	}
}

module.exports = PromptoPlugin;
