/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
"use strict";
var obsidian = require("obsidian");

// ═══ TYPES & CONSTANTS ═══════════════════════════════════

var VIEW_TYPE_PROMPTO = "prompto-library-view";

var DEFAULT_SETTINGS = {
	libraryPath: "Prompto Library",
	defaultRefiner: "grok",
	defaultSendTo: "grok",
	grokApiKey: "",
	claudeApiKey: "",
	openaiApiKey: "",
	veniceApiKey: "",
	veniceModel: "llama-3.3-70b",
	ollamaUrl: "http://localhost:11434",
	ollamaModel: "llama3",
	autoDetectContext: true,
	autoAdapt: true,
	generateIndex: true,
	maxContextChars: 4000,
};

var CATEGORIES = [
	{ label: "All", icon: "layout-grid" },
	{ label: "Writing", icon: "pen-tool" },
	{ label: "Coding", icon: "code-2" },
	{ label: "Research", icon: "search" },
	{ label: "Product", icon: "package" },
	{ label: "Daily", icon: "calendar" },
	{ label: "Favorites", icon: "flag" },
];

var PROVIDER_NAMES = {
	grok: "Grok (xAI)",
	claude: "Claude",
	openai: "GPT-4o",
	venice: "Venice.ai",
	ollama: "Ollama",
};

var PROVIDER_ICONS = {
	grok: "zap",
	claude: "brain",
	openai: "sparkles",
	venice: "shield",
	ollama: "server",
};

// ═══ FRONTMATTER UTILS ══════════════════════════════════

function parseYamlSimple(block) {
	var result = {};
	var lines = block.split("\n");
	for (var i = 0; i < lines.length; i++) {
		var cleaned = lines[i].replace(/\r$/, "");
		var m = cleaned.match(/^(\w+):\s*(.*)$/);
		if (!m) continue;
		var val = m[2].trim();
		if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) {
			val = val.slice(1, -1);
		}
		result[m[1]] = val;
	}
	return result;
}

function parseArray(val) {
	if (!val) return [];
	if (Array.isArray(val)) return val;
	var str = String(val).trim();
	if (str.startsWith("[") && str.endsWith("]")) {
		return str.slice(1, -1).split(",").map(function(s) { return s.trim().replace(/^["']|["']$/g, ""); }).filter(Boolean);
	}
	return str ? [str] : [];
}

async function parsePromptFile(app, file) {
	try {
		var raw = await app.vault.read(file);
		var content = raw.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
		var fmMatch = content.match(/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/);
		if (!fmMatch) return null;
		var fm = parseYamlSimple(fmMatch[1]);
		if (!fm["name"] && !fm["category"]) return null;
		return {
			path: file.path,
			name: fm["name"] || file.basename,
			category: fm["category"] || "Daily",
			tags: parseArray(fm["tags"]),
			variables: parseArray(fm["variables"]),
			version: parseInt(fm["version"], 10) || 1,
			effectiveness: parseFloat(fm["effectiveness"]) || 0,
			lastUsed: fm["lastUsed"] || "",
			icon: fm["icon"] || "file-text",
			body: fmMatch[2].trim(),
			favorite: fm["favorite"] === "true",
		};
	} catch (e) {
		console.error("Prompto: Error parsing " + file.path, e);
		return null;
	}
}

async function updateFrontmatterField(app, filePath, field, value) {
	var file = app.vault.getAbstractFileByPath(filePath);
	if (!(file instanceof obsidian.TFile)) return;
	var raw = await app.vault.read(file);
	var content = raw.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
	var fmMatch = content.match(/^---\n([\s\S]*?)\n---/);
	if (!fmMatch) return;
	var fmBlock = fmMatch[1];
	var formatted = typeof value === "string" ? '"' + value + '"' : String(value);
	var fieldRegex = new RegExp("^(" + field + ":\\s*).*$", "m");
	var newFm = fieldRegex.test(fmBlock) ? fmBlock.replace(fieldRegex, "$1" + formatted) : fmBlock + "\n" + field + ": " + formatted;
	content = content.replace(/^---\n[\s\S]*?\n---/, "---\n" + newFm + "\n---");
	await app.vault.modify(file, content);
}

function generateIndexContent(prompts) {
	var now = new Date().toISOString().slice(0, 10);
	var cats = {}, totalEff = 0, rated = 0;
	for (var i = 0; i < prompts.length; i++) {
		cats[prompts[i].category] = (cats[prompts[i].category] || 0) + 1;
		if (prompts[i].effectiveness > 0) { totalEff += prompts[i].effectiveness; rated++; }
	}
	var avgEff = rated > 0 ? (totalEff / rated).toFixed(1) : "N/A";
	var top = prompts.filter(function(p) { return p.effectiveness > 0; }).sort(function(a, b) { return b.effectiveness - a.effectiveness; }).slice(0, 5);
	var md = "# \uD83D\uDCCB Prompto Library Index\n\n*Auto-generated on " + now + "*\n\n";
	md += "## Stats\n\n| Metric | Value |\n|--------|-------|\n";
	md += "| Total prompts | " + prompts.length + " |\n| Average effectiveness | " + avgEff + " \u2B50 |\n| Categories | " + Object.keys(cats).length + " |\n\n";
	md += "## By Category\n\n";
	Object.entries(cats).sort(function(a, b) { return b[1] - a[1]; }).forEach(function(e) { md += "- **" + e[0] + "**: " + e[1] + " prompts\n"; });
	if (top.length > 0) { md += "\n## Top Rated\n\n"; top.forEach(function(p) { md += "- **" + p.name + "** \u2014 " + p.effectiveness + " \u2B50 (" + p.category + ")\n"; }); }
	md += "\n---\n*Managed by [Prompto](https://github.com/prompto-obsidian/prompto)*\n";
	return md;
}

// ═══ CONTEXT GATHERING ══════════════════════════════════

function gatherContext(app, maxChars) {
	var ctx = { selectedText: "", activeNoteContent: "", activeNoteTitle: "", activeNotePath: "", backlinks: [], recentNotes: [], activeNoteSummary: "" };
	// Try active view first, then fall back to most recent MarkdownView leaf
	var view = app.workspace.getActiveViewOfType(obsidian.MarkdownView);
	if (!view) {
		// Sidebar is likely focused — find the most recent markdown leaf
		var leaves = app.workspace.getLeavesOfType("markdown");
		for (var li = 0; li < leaves.length; li++) {
			if (leaves[li].view instanceof obsidian.MarkdownView) {
				view = leaves[li].view;
				break;
			}
		}
	}
	if (view) {
		ctx.selectedText = view.editor.getSelection() || "";
		var file = view.file;
		if (file) {
			ctx.activeNoteTitle = file.basename;
			ctx.activeNotePath = file.path;
			var c = view.editor.getValue();
			ctx.activeNoteContent = c.slice(0, maxChars);
			ctx.activeNoteSummary = c.slice(0, 500);
			var allLinks = app.metadataCache.resolvedLinks;
			for (var sp in allLinks) {
				if (allLinks[sp][file.path] > 0) {
					var sf = app.vault.getAbstractFileByPath(sp);
					if (sf instanceof obsidian.TFile) ctx.backlinks.push(sf.basename);
				}
			}
			ctx.backlinks = ctx.backlinks.slice(0, 10);
		}
	}
	var recent = [];
	app.workspace.iterateAllLeaves(function(leaf) {
		if (leaf.view instanceof obsidian.MarkdownView && leaf.view.file) {
			var t = leaf.view.file.basename;
			if (recent.indexOf(t) === -1) recent.push(t);
		}
	});
	ctx.recentNotes = recent.slice(0, 5);
	return ctx;
}

function formatContextForRefiner(ctx) {
	var parts = [];
	if (ctx.selectedText) parts.push("## Selected Text\n" + ctx.selectedText);
	if (ctx.activeNoteTitle) parts.push('## Active Note: "' + ctx.activeNoteTitle + '" (' + ctx.activeNotePath + ")");
	if (ctx.activeNoteSummary) parts.push("## Note Summary\n" + ctx.activeNoteSummary);
	if (ctx.backlinks.length > 0) parts.push("## Backlinks\n" + ctx.backlinks.join(", "));
	if (ctx.recentNotes.length > 0) parts.push("## Recent Notes\n" + ctx.recentNotes.join(", "));
	return parts.join("\n\n");
}

// ═══ LLM API CALLS ══════════════════════════════════════

function isProviderConfigured(provider, s) {
	switch (provider) {
		case "grok": return !!s.grokApiKey;
		case "claude": return !!s.claudeApiKey;
		case "openai": return !!s.openaiApiKey;
		case "venice": return !!s.veniceApiKey;
		case "ollama": return !!s.ollamaUrl;
	}
	return false;
}

async function sendToLLM(provider, systemPrompt, userMessage, settings) {
	switch (provider) {
		case "grok": return _grok(systemPrompt, userMessage, settings.grokApiKey);
		case "claude": return _claude(systemPrompt, userMessage, settings.claudeApiKey);
		case "openai": return _openai(systemPrompt, userMessage, settings.openaiApiKey);
		case "venice": return _venice(systemPrompt, userMessage, settings.veniceApiKey, settings.veniceModel);
		case "ollama": return _ollama(systemPrompt, userMessage, settings.ollamaUrl, settings.ollamaModel);
		default: throw new Error("Unknown provider: " + provider);
	}
}

async function _grok(sys, usr, key) {
	if (!key) throw new Error("Grok API key not configured. Add it in Prompto Settings.");
	var r = await obsidian.requestUrl({ url: "https://api.x.ai/v1/chat/completions", method: "POST",
		headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
		body: JSON.stringify({ model: "grok-3-latest", messages: [{ role: "system", content: sys }, { role: "user", content: usr }], temperature: 0.7, max_tokens: 4096 }) });
	if (r.status !== 200) throw new Error("Grok error " + r.status);
	return r.json.choices[0].message.content || "";
}

async function _claude(sys, usr, key) {
	if (!key) throw new Error("Claude API key not configured. Add it in Prompto Settings.");
	var r = await obsidian.requestUrl({ url: "https://api.anthropic.com/v1/messages", method: "POST",
		headers: { "Content-Type": "application/json", "x-api-key": key, "anthropic-version": "2023-06-01" },
		body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 4096, system: sys, messages: [{ role: "user", content: usr }] }) });
	if (r.status !== 200) throw new Error("Claude error " + r.status);
	return (r.json.content || []).map(function(b) { return b.text || ""; }).join("");
}

async function _openai(sys, usr, key) {
	if (!key) throw new Error("OpenAI API key not configured. Add it in Prompto Settings.");
	var r = await obsidian.requestUrl({ url: "https://api.openai.com/v1/chat/completions", method: "POST",
		headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
		body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "system", content: sys }, { role: "user", content: usr }], temperature: 0.7, max_tokens: 4096 }) });
	if (r.status !== 200) throw new Error("OpenAI error " + r.status);
	return r.json.choices[0].message.content || "";
}

async function _venice(sys, usr, key, model) {
	if (!key) throw new Error("Venice.ai API key not configured. Add it in Prompto Settings.");
	var r = await obsidian.requestUrl({ url: "https://api.venice.ai/api/v1/chat/completions", method: "POST",
		headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
		body: JSON.stringify({ model: model || "llama-3.3-70b", messages: [{ role: "system", content: sys }, { role: "user", content: usr }], temperature: 0.7, max_tokens: 4096 }) });
	if (r.status !== 200) throw new Error("Venice error " + r.status);
	return r.json.choices[0].message.content || "";
}

async function _ollama(sys, usr, url, model) {
	if (!url) throw new Error("Ollama URL not configured. Add it in Prompto Settings.");
	var r = await obsidian.requestUrl({ url: url + "/api/chat", method: "POST",
		headers: { "Content-Type": "application/json" },
		body: JSON.stringify({ model: model || "llama3", messages: [{ role: "system", content: sys }, { role: "user", content: usr }], stream: false }) });
	if (r.status !== 200) throw new Error("Ollama error " + r.status);
	return r.json.message.content || "";
}

// ═══ ADAPTER (REFINER) ══════════════════════════════════

var REFINER_SYSTEM_PROMPT = "You are Prompto Refiner, an expert prompt engineer embedded inside Obsidian. Your sole job is to take a raw prompt template and intelligently adapt it using the user's current context.\n\nRULES:\n1. PRESERVE the original prompt's intent, structure, and voice completely.\n2. REPLACE {{placeholders}} with the best values derived from context. If a value is explicitly provided, use it. If not, infer from context.\n3. SHARPEN specificity: replace vague references with concrete details from context.\n4. ADD relevant context where it makes the prompt more effective.\n5. MAINTAIN the prompt's category-appropriate tone.\n6. NEVER add meta-commentary about your adaptation process.\n7. NEVER wrap output in markdown code blocks.\n8. If context is minimal, still produce the best possible version.\n9. Keep roughly the same length unless expansion genuinely improves it.\n10. Output ONLY the final adapted prompt text.";

function escapeRegex(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }

function fillVariables(body, values) {
	var result = body;
	for (var key in values) {
		if (values.hasOwnProperty(key)) {
			result = result.replace(new RegExp("\\{\\{\\s*" + escapeRegex(key) + "\\s*\\}\\}", "gi"), values[key]);
		}
	}
	return result;
}

async function adaptPrompt(prompt, filledBody, contextStr, settings) {
	try {
		var resp = await sendToLLM(settings.defaultRefiner, REFINER_SYSTEM_PROMPT, "PROMPT TEMPLATE:\n" + filledBody + "\n\nUSER CONTEXT:\n" + contextStr, settings);
		return { adaptedPrompt: resp.trim(), adaptationNotes: "Adapted by " + settings.defaultRefiner + ' using context from "' + prompt.name + '"' };
	} catch (e) {
		return { adaptedPrompt: filledBody, adaptationNotes: "Adaptation failed (" + (e instanceof Error ? e.message : "error") + "). Showing original." };
	}
}

// ═══ RESPONSE MODAL ═════════════════════════════════════

class ResponseModal extends obsidian.Modal {
	constructor(app, prompt, response, provider) {
		super(app); this.prompt = prompt; this.response = response; this.provider = provider;
	}
	onOpen() {
		var self = this, el = this.contentEl;
		el.empty(); el.addClass("prompto-response-modal");
		var h = el.createDiv({ cls: "prompto-response-header" });
		var t = h.createEl("h2", { text: "Response from " + this.provider });
		obsidian.setIcon(t.createSpan({ cls: "prompto-header-icon" }), "message-square");
		var rc = el.createDiv({ cls: "prompto-response-content" });
		obsidian.MarkdownRenderer.render(this.app, this.response, rc, "", this);
		var actions = el.createDiv({ cls: "prompto-response-actions" });
		var cb = actions.createEl("button", { cls: "prompto-btn prompto-btn-primary" });
		obsidian.setIcon(cb.createSpan(), "copy"); cb.createSpan({ text: " Copy Response" });
		cb.addEventListener("click", function() { navigator.clipboard.writeText(self.response); new obsidian.Notice("Copied!"); });
		var ib = actions.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(ib.createSpan(), "file-input"); ib.createSpan({ text: " Insert into Note" });
		ib.addEventListener("click", function() {
			var v = self.app.workspace.getActiveViewOfType(obsidian.MarkdownView);
			if (v) { v.editor.replaceSelection(self.response); new obsidian.Notice("Inserted!"); self.close(); }
			else new obsidian.Notice("No active note.");
		});
		el.createEl("hr");
		var rs = el.createDiv({ cls: "prompto-rating-section" });
		rs.createEl("h3", { text: "Rate this prompt's effectiveness" });
		var sc = rs.createDiv({ cls: "prompto-stars" });
		for (var i = 1; i <= 5; i++) {
			var star = sc.createEl("button", { cls: "prompto-star-btn" });
			obsidian.setIcon(star, "star");
			star.style.opacity = i <= Math.round(this.prompt.effectiveness) ? "1" : "0.3";
			(function(rating) { star.addEventListener("click", async function() {
				var oldE = self.prompt.effectiveness || rating;
				var newE = Math.round(((oldE + rating) / 2) * 10) / 10;
				await updateFrontmatterField(self.app, self.prompt.path, "effectiveness", newE);
				await updateFrontmatterField(self.app, self.prompt.path, "lastUsed", new Date().toISOString().slice(0, 10));
				new obsidian.Notice("Rated " + rating + " \u2B50 — updated to " + newE);
				sc.querySelectorAll(".prompto-star-btn").forEach(function(s, idx) { s.style.opacity = idx < rating ? "1" : "0.3"; });
			}); })(i);
		}
	}
	onClose() { this.contentEl.empty(); }
}

// ═══ PREVIEW MODAL ══════════════════════════════════════

class PreviewModal extends obsidian.Modal {
	constructor(app, prompt, settings) {
		super(app); this.prompt = prompt; this.settings = settings;
		this.variableValues = {}; this.adaptedPrompt = prompt.body; this.leftPane = null; this.isAdapting = false;
		this.context = settings.autoDetectContext ? gatherContext(app, settings.maxContextChars)
			: { selectedText: "", activeNoteContent: "", activeNoteTitle: "", activeNotePath: "", backlinks: [], recentNotes: [], activeNoteSummary: "" };
		for (var vi = 0; vi < prompt.variables.length; vi++) {
			var v = prompt.variables[vi];
			this.variableValues[v] = (v === "selected_text" && this.context.selectedText) ? this.context.selectedText : "";
		}
	}
	async onOpen() {
		var self = this, el = this.contentEl;
		el.empty(); el.addClass("prompto-preview-modal");
		// Force the outer .modal container
		if (this.modalEl) {
			this.modalEl.style.maxWidth = "900px";
			this.modalEl.style.width = "90vw";
			this.modalEl.style.overflow = "hidden";
		}
		// Title
		var tb = el.createDiv({ cls: "prompto-modal-titlebar" });
		obsidian.setIcon(tb.createSpan({ cls: "prompto-modal-icon" }), this.prompt.icon || "file-text");
		tb.createEl("h2", { text: this.prompt.name });
		tb.createSpan({ cls: "prompto-category-badge", text: this.prompt.category });
		// Columns
		var cols = el.createDiv({ cls: "prompto-columns" });
		this.leftPane = cols.createDiv({ cls: "prompto-col-left" });
		var rp = cols.createDiv({ cls: "prompto-col-right" });
		// Context
		rp.createEl("h3", { text: "Detected Context" });
		var cs = rp.createDiv({ cls: "prompto-context-summary" });
		if (this.context.activeNoteTitle) cs.createEl("div", { cls: "prompto-ctx-item", text: "\uD83D\uDCC4 " + this.context.activeNoteTitle });
		if (this.context.selectedText) cs.createEl("div", { cls: "prompto-ctx-item", text: "\u2702\uFE0F Selection: " + this.context.selectedText.slice(0, 80) + (this.context.selectedText.length > 80 ? "\u2026" : "") });
		if (this.context.backlinks.length > 0) cs.createEl("div", { cls: "prompto-ctx-item", text: "\uD83D\uDD17 Backlinks: " + this.context.backlinks.slice(0, 3).join(", ") });
		if (!this.context.activeNoteTitle && !this.context.selectedText && this.context.backlinks.length === 0)
			cs.createEl("div", { cls: "prompto-ctx-item prompto-ctx-empty", text: "No context detected. Open a note or select text." });
		// Actions
		var ad = rp.createDiv({ cls: "prompto-actions" });
		var ab = ad.createEl("button", { cls: "prompto-btn prompto-btn-adapt" });
		obsidian.setIcon(ab.createSpan(), "wand-2");
		var at = ab.createSpan({ text: " Adapt with AI" });
		ab.addEventListener("click", function() { self.runAdaptation(ab, at); });
		var cpb = ad.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(cpb.createSpan(), "copy"); cpb.createSpan({ text: " Copy Prompt" });
		cpb.addEventListener("click", function() { navigator.clipboard.writeText(self.adaptedPrompt); new obsidian.Notice("Copied!"); });
		var inb = ad.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(inb.createSpan(), "file-input"); inb.createSpan({ text: " Insert into Note" });
		inb.addEventListener("click", function() {
			var mv = self.app.workspace.getActiveViewOfType(obsidian.MarkdownView);
			if (mv) { mv.editor.replaceSelection(self.adaptedPrompt); new obsidian.Notice("Inserted!"); self.close(); }
			else new obsidian.Notice("No active editor.");
		});
		// Send buttons
		rp.createEl("h3", { text: "Send to LLM" });
		var sd = rp.createDiv({ cls: "prompto-send-buttons" });
		var providers = ["grok", "claude", "openai", "venice", "ollama"];
		for (var pi = 0; pi < providers.length; pi++) {
			var p = providers[pi], cfg = isProviderConfigured(p, this.settings);
			var btn = sd.createEl("button", { cls: "prompto-btn prompto-send-btn" + (!cfg ? " prompto-btn-disabled" : "") });
			obsidian.setIcon(btn.createSpan(), PROVIDER_ICONS[p]);
			btn.createSpan({ text: " " + PROVIDER_NAMES[p] });
			if (!cfg) btn.title = "Not configured";
			(function(prov, button) { button.addEventListener("click", async function() {
				if (!isProviderConfigured(prov, self.settings)) { new obsidian.Notice(PROVIDER_NAMES[prov] + " not configured."); return; }
				await self.sendToProvider(prov, button);
			}); })(p, btn);
		}
		this.renderLeftPane();
		if (this.settings.autoAdapt && isProviderConfigured(this.settings.defaultRefiner, this.settings))
			await this.runAdaptation(ab, at);
	}
	renderLeftPane() {
		if (!this.leftPane) return;
		this.leftPane.empty();
		this.leftPane.createEl("h3", { text: "Prompt Preview" });
		var pd = this.leftPane.createDiv({ cls: "prompto-preview-content" });
		obsidian.MarkdownRenderer.render(this.app, fillVariables(this.adaptedPrompt, this.variableValues), pd, "", this);
	}
	async runAdaptation(btn, txt) {
		if (this.isAdapting) return; this.isAdapting = true;
		btn.addClass("prompto-btn-loading"); txt.setText(" Adapting...");
		try {
			var result = await adaptPrompt(this.prompt, fillVariables(this.prompt.body, this.variableValues), formatContextForRefiner(this.context), this.settings);
			this.adaptedPrompt = result.adaptedPrompt; this.renderLeftPane();
			new obsidian.Notice(result.adaptationNotes);
		} catch (e) { new obsidian.Notice("Adaptation failed: " + (e instanceof Error ? e.message : "Error")); }
		finally { this.isAdapting = false; btn.removeClass("prompto-btn-loading"); txt.setText(" Adapt with AI"); }
	}
	async sendToProvider(provider, btn) {
		btn.addClass("prompto-btn-loading");
		try {
			var fp = fillVariables(this.adaptedPrompt, this.variableValues);
			await updateFrontmatterField(this.app, this.prompt.path, "lastUsed", new Date().toISOString().slice(0, 10));
			var resp = await sendToLLM(provider, "You are a helpful, expert AI assistant.", fp, this.settings);
			this.close(); new ResponseModal(this.app, this.prompt, resp, PROVIDER_NAMES[provider]).open();
		} catch (e) { new obsidian.Notice("Send failed: " + (e instanceof Error ? e.message : "Error")); }
		finally { btn.removeClass("prompto-btn-loading"); }
	}
	onClose() { this.contentEl.empty(); }
}

// ═══ CREATE / EDIT PROMPT MODAL ══════════════════════════

class CreatePromptModal extends obsidian.Modal {
	constructor(app, settings, existingPrompt, onSave) {
		super(app);
		this.settings = settings;
		this.onSave = onSave;
		this.isEdit = !!existingPrompt;
		// Form state
		this.formData = existingPrompt ? {
			name: existingPrompt.name,
			category: existingPrompt.category,
			tags: existingPrompt.tags.join(", "),
			variables: existingPrompt.variables.join(", "),
			icon: existingPrompt.icon || "file-text",
			body: existingPrompt.body,
			path: existingPrompt.path,
		} : {
			name: "",
			category: "Writing",
			tags: "",
			variables: "",
			icon: "file-text",
			body: "",
			path: "",
		};
	}

	onOpen() {
		var self = this, el = this.contentEl;
		el.empty();
		el.addClass("prompto-create-modal");

		// Title
		el.createEl("h2", { text: this.isEdit ? "Edit Prompt" : "Create New Prompt" });

		// Name
		var nameGroup = el.createDiv({ cls: "prompto-form-group" });
		nameGroup.createEl("label", { text: "Prompt Name", cls: "prompto-form-label" });
		var nameInput = nameGroup.createEl("input", { type: "text", cls: "prompto-form-input", placeholder: "e.g. Ruthless Draft Critique" });
		nameInput.value = this.formData.name;
		nameInput.addEventListener("input", function() { self.formData.name = nameInput.value; });

		// Category dropdown
		var catGroup = el.createDiv({ cls: "prompto-form-group" });
		catGroup.createEl("label", { text: "Category", cls: "prompto-form-label" });
		var catDropdown = new obsidian.DropdownComponent(catGroup);
		var catOptions = ["Writing", "Coding", "Research", "Product", "Daily", "Custom..."];
		for (var i = 0; i < catOptions.length; i++) {
			catDropdown.addOption(catOptions[i], catOptions[i]);
		}
		// Custom category input (hidden by default)
		var customCatWrap = catGroup.createDiv({ cls: "prompto-form-custom-cat" });
		customCatWrap.style.display = "none";
		var customCatInput = customCatWrap.createEl("input", { type: "text", cls: "prompto-form-input", placeholder: "Enter custom category name..." });
		customCatInput.addEventListener("input", function() { self.formData.category = customCatInput.value; });
		// Check if existing category is custom
		var isStandard = ["Writing", "Coding", "Research", "Product", "Daily"].indexOf(this.formData.category) !== -1;
		if (!isStandard && this.formData.category) {
			catDropdown.setValue("Custom...");
			customCatWrap.style.display = "block";
			customCatInput.value = this.formData.category;
		} else {
			catDropdown.setValue(this.formData.category);
		}
		catDropdown.onChange(function(val) {
			if (val === "Custom...") {
				customCatWrap.style.display = "block";
				customCatInput.focus();
				self.formData.category = customCatInput.value || "";
			} else {
				customCatWrap.style.display = "none";
				self.formData.category = val;
			}
		});
		catDropdown.selectEl.addClass("prompto-form-dropdown");

		// Tags (chip/pill system)
		var tagsGroup = el.createDiv({ cls: "prompto-form-group" });
		tagsGroup.createEl("label", { text: "Tags", cls: "prompto-form-label" });
		var tagsChipWrap = tagsGroup.createDiv({ cls: "prompto-chip-wrap" });
		var tagsChipContainer = tagsChipWrap.createDiv({ cls: "prompto-chip-container" });
		var tagsInputEl = tagsChipWrap.createEl("input", { type: "text", cls: "prompto-chip-input", placeholder: "Type a tag and press Space or Enter..." });

		// Parse existing tags
		var currentTags = this.formData.tags ? this.formData.tags.split(",").map(function(s) { return s.trim(); }).filter(Boolean) : [];

		function renderTagChips() {
			tagsChipContainer.empty();
			for (var ti = 0; ti < currentTags.length; ti++) {
				(function(tag, idx) {
					var chip = tagsChipContainer.createDiv({ cls: "prompto-chip" });
					chip.createSpan({ text: tag });
					var removeBtn = chip.createSpan({ cls: "prompto-chip-remove", text: "\u00D7" });
					removeBtn.addEventListener("click", function() {
						currentTags.splice(idx, 1);
						self.formData.tags = currentTags.join(", ");
						renderTagChips();
					});
				})(currentTags[ti], ti);
			}
		}
		renderTagChips();

		function addTag(val) {
			var tag = val.trim().toLowerCase();
			if (tag && currentTags.indexOf(tag) === -1) {
				currentTags.push(tag);
				self.formData.tags = currentTags.join(", ");
				renderTagChips();
			}
			tagsInputEl.value = "";
		}

		tagsInputEl.addEventListener("keydown", function(e) {
			if (e.key === "Enter" || e.key === " " || e.key === ",") {
				e.preventDefault();
				addTag(tagsInputEl.value);
			}
			if (e.key === "Backspace" && !tagsInputEl.value && currentTags.length > 0) {
				currentTags.pop();
				self.formData.tags = currentTags.join(", ");
				renderTagChips();
			}
		});
		tagsInputEl.addEventListener("blur", function() { if (tagsInputEl.value.trim()) addTag(tagsInputEl.value); });

		// (Variables are auto-extracted from the prompt body when saving — no manual input needed)

		// Icon picker
		var iconGroup = el.createDiv({ cls: "prompto-form-group" });
		iconGroup.createEl("label", { text: "Icon", cls: "prompto-form-label" });
		var popularIcons = [
			"target", "pen-tool", "code-2", "search", "package", "calendar",
			"star", "zap", "brain", "lightbulb", "book-open", "file-text",
			"mail", "bug", "layers", "clipboard-list", "users", "bar-chart-2",
			"microscope", "graduation-cap", "sun", "list-checks", "message-square",
			"heart", "shield", "globe", "terminal", "database", "palette", "rocket",
			"compass", "feather", "coffee", "gift", "flag", "key", "map"
		];
		var iconGrid = iconGroup.createDiv({ cls: "prompto-icon-grid" });
		var selectedIconBtn = null;

		for (var ii = 0; ii < popularIcons.length; ii++) {
			(function(iconName) {
				var iconBtn = iconGrid.createDiv({ cls: "prompto-icon-btn" + (self.formData.icon === iconName ? " prompto-icon-btn-active" : "") });
				obsidian.setIcon(iconBtn, iconName);
				iconBtn.title = iconName;
				if (self.formData.icon === iconName) selectedIconBtn = iconBtn;
				iconBtn.addEventListener("click", function() {
					if (selectedIconBtn) selectedIconBtn.removeClass("prompto-icon-btn-active");
					iconBtn.addClass("prompto-icon-btn-active");
					selectedIconBtn = iconBtn;
					self.formData.icon = iconName;
					iconHint.empty();
					iconHint.createSpan({ text: "Selected: " });
					iconHint.createEl("strong", { text: iconName });
				});
			})(popularIcons[ii]);
		}
		var iconHint = iconGroup.createDiv({ cls: "prompto-form-hint" });
		iconHint.createSpan({ text: "Selected: " });
		iconHint.createEl("strong", { text: this.formData.icon });

		// Custom icon input
		var customIconRow = iconGroup.createDiv({ cls: "prompto-custom-icon-row" });
		var customIconInput = customIconRow.createEl("input", { type: "text", cls: "prompto-custom-icon-input", placeholder: "e.g. flame" });
		var customIconPreview = customIconRow.createDiv({ cls: "prompto-custom-icon-preview" });
		var customIconApply = customIconRow.createEl("button", { cls: "prompto-btn prompto-btn-sm", text: "Apply" });
		var iconLink = customIconRow.createEl("a", { text: "Browse icons", href: "https://lucide.dev/icons", cls: "prompto-form-hint" });
		iconLink.style.marginLeft = "4px";

		customIconInput.addEventListener("input", function() {
			customIconPreview.empty();
			var val = customIconInput.value.trim();
			if (val) {
				try { obsidian.setIcon(customIconPreview, val); } catch(e) { /* invalid icon */ }
			}
		});

		customIconApply.addEventListener("click", function() {
			var val = customIconInput.value.trim();
			if (val) {
				self.formData.icon = val;
				if (selectedIconBtn) selectedIconBtn.removeClass("prompto-icon-btn-active");
				selectedIconBtn = null;
				iconHint.empty();
				iconHint.createSpan({ text: "Selected: " });
				iconHint.createEl("strong", { text: val });
				new obsidian.Notice('Icon set to "' + val + '"');
			}
		});

		// Prompt Body
		var bodyGroup = el.createDiv({ cls: "prompto-form-group" });
		var bodyLabelRow = bodyGroup.createDiv({ cls: "prompto-form-label-row" });
		bodyLabelRow.createEl("label", { text: "Prompt Body", cls: "prompto-form-label" });
		var optimizeBtn = bodyLabelRow.createEl("button", { cls: "prompto-btn prompto-btn-optimize" });
		obsidian.setIcon(optimizeBtn.createSpan(), "wand-2");
		var optimizeTxt = optimizeBtn.createSpan({ text: " Optimize with AI" });
		var bodyTa = new obsidian.TextAreaComponent(bodyGroup);
		bodyTa.setPlaceholder("Write your prompt here in plain language.\n\nExample: \"Critique my writing ruthlessly. Point out weak arguments, vague language, and unclear structure. Give me specific, actionable feedback.\"\n\nTip: Just write what you want the AI to do. When you use this prompt later, Prompto will automatically adapt it to whatever you're working on — your current note, selected text, and surrounding context. Click 'Optimize with AI' to polish it.");
		bodyTa.setValue(this.formData.body);
		bodyTa.onChange(function(val) { self.formData.body = val; });
		bodyTa.inputEl.addClass("prompto-form-textarea");
		bodyTa.inputEl.rows = 12;

		// How it works hint
		var howItWorks = bodyGroup.createDiv({ cls: "prompto-form-hint prompto-how-it-works" });
		howItWorks.innerHTML = "<strong>How Prompto works:</strong> Write your prompt once. When you use it, Prompto reads your current context (selected text, active note, backlinks) and an AI refiner automatically adapts your prompt to fit. No setup needed — just write what you want the AI to do.";

		// Optimize with AI handler
		optimizeBtn.addEventListener("click", async function() {
			var rawBody = self.formData.body.trim();
			if (!rawBody) { new obsidian.Notice("Write your prompt idea first, then click Optimize."); return; }
			if (!isProviderConfigured(self.settings.defaultRefiner, self.settings)) {
				new obsidian.Notice("No API key configured. Add one in Prompto Settings first."); return;
			}
			optimizeBtn.addClass("prompto-btn-loading");
			optimizeTxt.setText(" Optimizing...");
			try {
				var sysPrompt = "You are an expert prompt engineer. The user has written a rough prompt idea. Your job is to transform it into a well-structured, highly effective prompt.\n\nRULES:\n1. Keep the user's core intent and goal.\n2. Add clear structure with sections (using **bold** headers).\n3. Make instructions specific and actionable.\n4. Add guidance for the AI on how to respond (format, length, style).\n5. Output ONLY the improved prompt text — no meta-commentary, no explanation, no code blocks.\n6. If the user already has a well-structured prompt, just refine and improve it.\n7. Keep it concise but thorough.\n8. Do NOT add {{variable}} placeholders — this prompt will be automatically adapted to the user's context at runtime by a separate AI refiner.";
				var userMsg = "ROUGH PROMPT IDEA:\n" + rawBody + "\n\nPROMPT NAME: " + (self.formData.name || "Untitled") + "\nCATEGORY: " + (self.formData.category || "General");
				var result = await sendToLLM(self.settings.defaultRefiner, sysPrompt, userMsg, self.settings);
				self.formData.body = result.trim();
				bodyTa.setValue(self.formData.body);
				// Auto-detect variables from the optimized prompt (in case AI still adds some)
				var varMatches = result.match(/\{\{(\w+)\}\}/g);
				if (varMatches) {
					var detectedVars = [];
					for (var vi = 0; vi < varMatches.length; vi++) {
						var vName = varMatches[vi].replace(/\{\{|\}\}/g, "");
						if (detectedVars.indexOf(vName) === -1) detectedVars.push(vName);
					}
					self.formData.variables = detectedVars.join(", ");
				}
				new obsidian.Notice("Prompt optimized!");
			} catch (e) {
				new obsidian.Notice("Optimization failed: " + (e instanceof Error ? e.message : "Error"));
			} finally {
				optimizeBtn.removeClass("prompto-btn-loading");
				optimizeTxt.setText(" Optimize with AI");
			}
		});

		// Buttons
		var btnRow = el.createDiv({ cls: "prompto-form-buttons" });
		var cancelBtn = btnRow.createEl("button", { cls: "prompto-btn", text: "Cancel" });
		cancelBtn.addEventListener("click", function() { self.close(); });

		var saveBtn = btnRow.createEl("button", { cls: "prompto-btn prompto-btn-primary" });
		obsidian.setIcon(saveBtn.createSpan(), "save");
		saveBtn.createSpan({ text: this.isEdit ? " Save Changes" : " Create Prompt" });
		saveBtn.addEventListener("click", async function() { await self.handleSave(); });
	}

	async handleSave() {
		var d = this.formData;
		if (!d.name.trim()) { new obsidian.Notice("Please enter a prompt name."); return; }
		if (!d.body.trim()) { new obsidian.Notice("Please enter the prompt body."); return; }

		var tags = d.tags.split(",").map(function(s) { return s.trim(); }).filter(Boolean);

		// Auto-extract variables from the prompt body
		var varMatches = d.body.match(/\{\{(\w+)\}\}/g);
		var vars = [];
		if (varMatches) {
			for (var vi = 0; vi < varMatches.length; vi++) {
				var vName = varMatches[vi].replace(/\{\{|\}\}/g, "");
				if (vars.indexOf(vName) === -1) vars.push(vName);
			}
		}

		var fm = "---\n";
		fm += 'name: "' + d.name.trim() + '"\n';
		fm += "category: " + d.category + "\n";
		fm += "tags: [" + tags.join(", ") + "]\n";
		fm += "variables: [" + vars.join(", ") + "]\n";
		fm += "version: 1\n";
		fm += "effectiveness: 0\n";
		fm += 'lastUsed: "' + new Date().toISOString().slice(0, 10) + '"\n';
		fm += 'icon: "' + (d.icon.trim() || "file-text") + '"\n';
		fm += "---\n\n";
		fm += d.body.trim();

		try {
			if (this.isEdit && d.path) {
				// Edit existing file
				var file = this.app.vault.getAbstractFileByPath(d.path);
				if (file instanceof obsidian.TFile) {
					await this.app.vault.modify(file, fm);
					new obsidian.Notice('Updated "' + d.name + '"!');
				}
			} else {
				// Create new file
				var filePath = this.settings.libraryPath + "/" + d.name.trim() + ".md";
				var existing = this.app.vault.getAbstractFileByPath(filePath);
				if (existing) { new obsidian.Notice('A prompt named "' + d.name + '" already exists.'); return; }
				await this.app.vault.create(filePath, fm);
				new obsidian.Notice('Created "' + d.name + '"!');
			}
			if (this.onSave) this.onSave();
			this.close();
		} catch (e) {
			new obsidian.Notice("Error saving: " + (e instanceof Error ? e.message : "Unknown error"));
		}
	}

	onClose() { this.contentEl.empty(); }
}

// ═══ INPUT MODAL (replaces browser prompt()) ════════════

class InputModal extends obsidian.Modal {
	constructor(app, title, placeholder, callback) {
		super(app);
		this.title = title;
		this.placeholder = placeholder || "";
		this.callback = callback;
		this.value = "";
	}
	onOpen() {
		var self = this, el = this.contentEl;
		el.createEl("h3", { text: this.title });
		var input = el.createEl("input", { type: "text", cls: "prompto-form-input", placeholder: this.placeholder });
		input.style.marginBottom = "12px";
		input.addEventListener("input", function() { self.value = input.value; });
		input.addEventListener("keydown", function(e) { if (e.key === "Enter") { self.callback(self.value); self.close(); } });
		var btnRow = el.createDiv({ cls: "prompto-form-buttons" });
		var cancelBtn = btnRow.createEl("button", { cls: "prompto-btn", text: "Cancel" });
		cancelBtn.addEventListener("click", function() { self.close(); });
		var okBtn = btnRow.createEl("button", { cls: "prompto-btn prompto-btn-primary", text: "OK" });
		okBtn.addEventListener("click", function() { self.callback(self.value); self.close(); });
		setTimeout(function() { input.focus(); }, 50);
	}
	onClose() { this.contentEl.empty(); }
}

// ═══ MANAGE LIBRARY MODAL ═══════════════════════════════

class ManageModal extends obsidian.Modal {
	constructor(app, plugin) {
		super(app);
		this.plugin = plugin;
		this.prompts = [];
		this.filteredPrompts = [];
		this.selectedPaths = new Set();
		this.sortField = "name";
		this.sortAsc = true;
		this.filterText = "";
		this.filterCategory = "All";
	}

	async onOpen() {
		await this.loadPrompts();
		this.render();
	}

	async loadPrompts() {
		this.prompts = [];
		var folder = this.app.vault.getAbstractFileByPath(this.plugin.settings.libraryPath);
		if (!(folder instanceof obsidian.TFolder)) return;
		for (var i = 0; i < folder.children.length; i++) {
			var child = folder.children[i];
			if (child instanceof obsidian.TFile && child.extension === "md" && !child.basename.startsWith("_")) {
				var pf = await parsePromptFile(this.app, child);
				if (pf) this.prompts.push(pf);
			}
		}
		this.applyFilters();
	}

	applyFilters() {
		var self = this;
		this.filteredPrompts = this.prompts.filter(function(p) {
			if (self.filterCategory !== "All" && p.category !== self.filterCategory) return false;
			if (self.filterText) {
				var q = self.filterText.toLowerCase();
				return p.name.toLowerCase().indexOf(q) !== -1 ||
					p.tags.join(" ").toLowerCase().indexOf(q) !== -1 ||
					p.category.toLowerCase().indexOf(q) !== -1 ||
					p.body.toLowerCase().indexOf(q) !== -1;
			}
			return true;
		});
		// Sort
		var field = this.sortField, asc = this.sortAsc;
		this.filteredPrompts.sort(function(a, b) {
			var va, vb;
			if (field === "name") { va = a.name.toLowerCase(); vb = b.name.toLowerCase(); }
			else if (field === "category") { va = a.category; vb = b.category; }
			else if (field === "favorite") { va = a.favorite ? 1 : 0; vb = b.favorite ? 1 : 0; }
			else if (field === "lastUsed") { va = a.lastUsed || ""; vb = b.lastUsed || ""; }
			else if (field === "tags") { va = a.tags.join(", "); vb = b.tags.join(", "); }
			else { va = a.name; vb = b.name; }
			if (va < vb) return asc ? -1 : 1;
			if (va > vb) return asc ? 1 : -1;
			return 0;
		});
	}

	render() {
		var self = this, el = this.contentEl;
		el.empty();
		el.addClass("prompto-manage-modal");
		// Force the outer .modal container to be wide
		if (this.modalEl) {
			this.modalEl.style.maxWidth = "1700px";
			this.modalEl.style.width = "97vw";
			this.modalEl.style.overflow = "hidden";
		}

		// Header
		var header = el.createDiv({ cls: "prompto-manage-header" });
		var titleRow = header.createDiv({ cls: "prompto-manage-title-row" });
		obsidian.setIcon(titleRow.createSpan({ cls: "prompto-modal-icon" }), "library");
		titleRow.createEl("h2", { text: "Manage Prompt Library" });
		var badge = titleRow.createSpan({ cls: "prompto-count-badge", text: this.prompts.length + " prompts" });
		badge.style.marginLeft = "0";

		// Filter bar
		var filterBar = header.createDiv({ cls: "prompto-manage-filter-bar" });
		var searchInput = filterBar.createEl("input", { type: "text", cls: "prompto-manage-search", placeholder: "Filter prompts..." });
		searchInput.value = this.filterText;
		searchInput.addEventListener("input", function() { self.filterText = searchInput.value; self.applyFilters(); self.renderTable(); });

		var catDrop = new obsidian.DropdownComponent(filterBar);
		var cats = ["All"];
		var seenCats = {};
		for (var i = 0; i < this.prompts.length; i++) {
			if (!seenCats[this.prompts[i].category]) { cats.push(this.prompts[i].category); seenCats[this.prompts[i].category] = true; }
		}
		for (var c = 0; c < cats.length; c++) catDrop.addOption(cats[c], cats[c]);
		catDrop.setValue(this.filterCategory);
		catDrop.onChange(function(v) { self.filterCategory = v; self.applyFilters(); self.renderTable(); });
		catDrop.selectEl.addClass("prompto-manage-cat-filter");

		// Bulk action bar
		this.bulkBar = header.createDiv({ cls: "prompto-manage-bulk-bar" });
		this.renderBulkBar();

		// Table container
		this.tableContainer = el.createDiv({ cls: "prompto-manage-table-wrap" });
		this.renderTable();

		// Export bar
		var exportBar = el.createDiv({ cls: "prompto-manage-export-bar" });
		exportBar.createSpan({ text: "Import / Export: ", cls: "prompto-form-hint" });

		var formats = [
			{ label: "JSON", icon: "file-json", ext: "json" },
			{ label: "CSV", icon: "file-spreadsheet", ext: "csv" },
			{ label: "Markdown", icon: "file-text", ext: "md" },
			{ label: "YAML", icon: "file-code", ext: "yaml" },
			{ label: "PDF", icon: "file-check", ext: "pdf" },
		];
		for (var fi = 0; fi < formats.length; fi++) {
			(function(fmt) {
				var btn = exportBar.createEl("button", { cls: "prompto-btn prompto-btn-export" });
				obsidian.setIcon(btn.createSpan(), fmt.icon);
				btn.createSpan({ text: " " + fmt.label });
				btn.addEventListener("click", function() { self.exportAs(fmt.ext); });
			})(formats[fi]);
		}

		// Import button
		var importBtn = exportBar.createEl("button", { cls: "prompto-btn prompto-btn-export" });
		obsidian.setIcon(importBtn.createSpan(), "file-input");
		importBtn.createSpan({ text: " Import JSON" });
		importBtn.addEventListener("click", function() { self.importJSON(); });
	}

	renderBulkBar() {
		var self = this;
		this.bulkBar.empty();
		var count = this.selectedPaths.size;
		if (count === 0) {
			this.bulkBar.createSpan({ text: "Select prompts to perform bulk actions", cls: "prompto-form-hint" });
			return;
		}
		this.bulkBar.createSpan({ text: count + " selected", cls: "prompto-manage-selected-count" });

		// Delete button
		var delBtn = this.bulkBar.createEl("button", { cls: "prompto-btn prompto-btn-danger" });
		obsidian.setIcon(delBtn.createSpan(), "trash-2");
		delBtn.createSpan({ text: " Delete" });
		delBtn.addEventListener("click", async function() {
			if (!confirm("Delete " + count + " prompt(s)? This cannot be undone.")) return;
			var paths = Array.from(self.selectedPaths);
			for (var i = 0; i < paths.length; i++) {
				var file = self.app.vault.getAbstractFileByPath(paths[i]);
				if (file instanceof obsidian.TFile) await self.app.vault.delete(file);
			}
			self.selectedPaths.clear();
			new obsidian.Notice("Deleted " + paths.length + " prompt(s).");
			await self.loadPrompts();
			self.render();
		});

		// Mass edit category
		var catBtn = this.bulkBar.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(catBtn.createSpan(), "folder-edit");
		catBtn.createSpan({ text: " Set Category" });
		catBtn.addEventListener("click", function() { self.bulkEditField("category"); });

		// Mass add tag
		var tagBtn = this.bulkBar.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(tagBtn.createSpan(), "tag");
		tagBtn.createSpan({ text: " Add Tag" });
		tagBtn.addEventListener("click", function() { self.bulkAddTag(); });

		// Mass find & replace in body
		var frBtn = this.bulkBar.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(frBtn.createSpan(), "replace");
		frBtn.createSpan({ text: " Find & Replace" });
		frBtn.addEventListener("click", function() { self.bulkFindReplace(); });

		// Mass toggle favorite
		var favBtn = this.bulkBar.createEl("button", { cls: "prompto-btn" });
		obsidian.setIcon(favBtn.createSpan(), "flag");
		favBtn.createSpan({ text: " Toggle Favorite" });
		favBtn.addEventListener("click", function() { self.bulkToggleFavorite(); });
	}

	renderTable() {
		var self = this;
		if (!this.tableContainer) return;
		this.tableContainer.empty();

		if (this.filteredPrompts.length === 0) {
			var emp = this.tableContainer.createDiv({ cls: "prompto-empty" });
			emp.createEl("p", { text: "No prompts match the current filter." });
			return;
		}

		var table = this.tableContainer.createEl("table", { cls: "prompto-manage-table" });
		var thead = table.createEl("thead");
		var hr = thead.createEl("tr");

		// Checkbox header — select all
		var thCb = hr.createEl("th", { cls: "prompto-manage-th-cb" });
		var selectAll = thCb.createEl("input", { type: "checkbox" });
		selectAll.checked = this.selectedPaths.size === this.filteredPrompts.length && this.filteredPrompts.length > 0;
		selectAll.addEventListener("change", function() {
			if (selectAll.checked) {
				for (var i = 0; i < self.filteredPrompts.length; i++) self.selectedPaths.add(self.filteredPrompts[i].path);
			} else { self.selectedPaths.clear(); }
			self.renderTable();
			self.renderBulkBar();
		});

		var columns = [
			{ key: "name", label: "Name" },
			{ key: "category", label: "Category" },
			{ key: "tags", label: "Tags" },
			{ key: "favorite", label: "Favorite" },
			{ key: "lastUsed", label: "Last Used" },
		];

		for (var ci = 0; ci < columns.length; ci++) {
			(function(col) {
				var th = hr.createEl("th", { cls: "prompto-manage-th" + (col.key === "name" ? " prompto-manage-th-name" : "") });
				th.createSpan({ text: col.label });
				if (self.sortField === col.key) {
					th.createSpan({ text: self.sortAsc ? " \u25B2" : " \u25BC", cls: "prompto-sort-indicator" });
				}
				th.addEventListener("click", function() {
					if (self.sortField === col.key) self.sortAsc = !self.sortAsc;
					else { self.sortField = col.key; self.sortAsc = true; }
					self.applyFilters();
					self.renderTable();
				});
			})(columns[ci]);
		}
		hr.createEl("th", { text: "Actions", cls: "prompto-manage-th" });

		var tbody = table.createEl("tbody");
		for (var ri = 0; ri < this.filteredPrompts.length; ri++) {
			(function(prompt) {
				var tr = tbody.createEl("tr", { cls: self.selectedPaths.has(prompt.path) ? "prompto-manage-row-selected" : "" });

				// Checkbox
				var tdCb = tr.createEl("td");
				var cb = tdCb.createEl("input", { type: "checkbox" });
				cb.checked = self.selectedPaths.has(prompt.path);
				cb.addEventListener("change", function() {
					if (cb.checked) self.selectedPaths.add(prompt.path);
					else self.selectedPaths.delete(prompt.path);
					tr.toggleClass("prompto-manage-row-selected", cb.checked);
					self.renderBulkBar();
				});

				// Name + icon
				var tdName = tr.createEl("td", { cls: "prompto-manage-td-name" });
				obsidian.setIcon(tdName.createSpan({ cls: "prompto-manage-icon" }), prompt.icon || "file-text");
				tdName.createSpan({ text: prompt.name });

				// Category
				tr.createEl("td").createSpan({ cls: "prompto-card-category", text: prompt.category });

				// Tags
				var tdTags = tr.createEl("td");
				for (var t = 0; t < Math.min(prompt.tags.length, 4); t++) {
					tdTags.createSpan({ cls: "prompto-card-tag", text: prompt.tags[t] });
				}
				if (prompt.tags.length > 4) tdTags.createSpan({ cls: "prompto-card-tag", text: "+" + (prompt.tags.length - 4) });

				// Favorite
				var tdFav = tr.createEl("td");
				var favBtn = tdFav.createEl("span", { cls: "prompto-card-fav", title: prompt.favorite ? "Unfavorite" : "Favorite" });
				favBtn.style.position = "relative";
				favBtn.style.cursor = "pointer";
				obsidian.setIcon(favBtn, prompt.favorite ? "flag" : "flag-off");
				(function(p, btn) { btn.addEventListener("click", async function(e) {
					e.stopPropagation();
					var newVal = !p.favorite;
					await updateFrontmatterField(self.app, p.path, "favorite", newVal);
					p.favorite = newVal;
					obsidian.setIcon(btn, newVal ? "flag" : "flag-off");
					btn.title = newVal ? "Unfavorite" : "Favorite";
				}); })(prompt, favBtn);

				// Last used
				tr.createEl("td", { text: prompt.lastUsed || "—", cls: "prompto-manage-date" });

				// Actions
				var tdAct = tr.createEl("td", { cls: "prompto-manage-actions" });
				var editBtn = tdAct.createEl("button", { cls: "prompto-card-action-btn prompto-manage-action-visible", title: "Edit" });
				obsidian.setIcon(editBtn, "pencil");
				editBtn.addEventListener("click", function(e) {
					e.stopPropagation();
					new CreatePromptModal(self.app, self.plugin.settings, prompt, async function() {
						await self.loadPrompts(); self.render();
					}).open();
				});

				var openBtn = tdAct.createEl("button", { cls: "prompto-card-action-btn prompto-manage-action-visible", title: "Open file" });
				obsidian.setIcon(openBtn, "file-text");
				openBtn.addEventListener("click", function(e) {
					e.stopPropagation();
					var file = self.app.vault.getAbstractFileByPath(prompt.path);
					if (file instanceof obsidian.TFile) { self.app.workspace.getLeaf(false).openFile(file); self.close(); }
				});

				var delBtn = tdAct.createEl("button", { cls: "prompto-card-action-btn prompto-manage-action-visible", title: "Delete" });
				obsidian.setIcon(delBtn, "trash-2");
				delBtn.addEventListener("click", async function(e) {
					e.stopPropagation();
					if (!confirm('Delete "' + prompt.name + '"?')) return;
					var file = self.app.vault.getAbstractFileByPath(prompt.path);
					if (file instanceof obsidian.TFile) await self.app.vault.delete(file);
					new obsidian.Notice('Deleted "' + prompt.name + '"');
					await self.loadPrompts(); self.render();
				});
			})(this.filteredPrompts[ri]);
		}
	}

	async bulkEditField(field) {
		var self = this;
		new InputModal(this.app, "Set " + field + " for " + this.selectedPaths.size + " prompt(s)", "e.g. Writing", async function(val) {
			if (!val || !val.trim()) return;
			var paths = Array.from(self.selectedPaths);
			for (var i = 0; i < paths.length; i++) {
				await updateFrontmatterField(self.app, paths[i], field, val.trim());
			}
			new obsidian.Notice("Updated " + field + " on " + paths.length + " prompt(s).");
			await self.loadPrompts();
			self.render();
		}).open();
	}

	async bulkAddTag() {
		var self = this;
		new InputModal(this.app, "Add tag to " + this.selectedPaths.size + " prompt(s)", "e.g. productivity", async function(tag) {
			if (!tag || !tag.trim()) return;
			tag = tag.trim().toLowerCase();
			var paths = Array.from(self.selectedPaths);
			for (var i = 0; i < paths.length; i++) {
				var file = self.app.vault.getAbstractFileByPath(paths[i]);
				if (!(file instanceof obsidian.TFile)) continue;
				var raw = await self.app.vault.read(file);
				var content = raw.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
				content = content.replace(/^(tags:\s*\[)(.*?)(\])/m, function(match, p1, p2, p3) {
					var existing = p2.split(",").map(function(s) { return s.trim(); }).filter(Boolean);
					if (existing.indexOf(tag) === -1) existing.push(tag);
					return p1 + existing.join(", ") + p3;
				});
				await self.app.vault.modify(file, content);
			}
			new obsidian.Notice('Added tag "' + tag + '" to ' + paths.length + " prompt(s).");
			await self.loadPrompts();
			self.render();
		}).open();
	}

	async bulkFindReplace() {
		var self = this;
		new InputModal(this.app, "Find text (in prompt body)", "Text to find...", function(find) {
			if (!find || !find.trim()) return;
			new InputModal(self.app, 'Replace "' + find + '" with:', "Replacement text...", async function(replace) {
				if (replace === null) return;
				var paths = Array.from(self.selectedPaths);
				var changed = 0;
				for (var i = 0; i < paths.length; i++) {
					var file = self.app.vault.getAbstractFileByPath(paths[i]);
					if (!(file instanceof obsidian.TFile)) continue;
					var raw = await self.app.vault.read(file);
					if (raw.indexOf(find) === -1) continue;
					var updated = raw.split(find).join(replace);
					await self.app.vault.modify(file, updated);
					changed++;
				}
				new obsidian.Notice("Replaced in " + changed + " of " + paths.length + " prompt(s).");
				await self.loadPrompts();
				self.render();
			}).open();
		}).open();
	}

	async bulkToggleFavorite() {
		var self = this;
		var paths = Array.from(this.selectedPaths);
		// If any selected prompt is NOT a favorite, we favorite all; otherwise unfavorite all
		var anyNotFav = false;
		for (var i = 0; i < this.filteredPrompts.length; i++) {
			if (this.selectedPaths.has(this.filteredPrompts[i].path) && !this.filteredPrompts[i].favorite) { anyNotFav = true; break; }
		}
		var newVal = anyNotFav;
		for (var i = 0; i < paths.length; i++) {
			await updateFrontmatterField(this.app, paths[i], "favorite", newVal);
		}
		new obsidian.Notice((newVal ? "Favorited " : "Unfavorited ") + paths.length + " prompt(s).");
		await this.loadPrompts();
		this.render();
	}

	async exportAs(format) {
		var data = this.filteredPrompts.length > 0 ? this.filteredPrompts : this.prompts;
		var filename, content;

		if (format === "json") {
			filename = "prompto-library.json";
			var exportData = data.map(function(p) {
				return { name: p.name, category: p.category, tags: p.tags, variables: p.variables, icon: p.icon, effectiveness: p.effectiveness, lastUsed: p.lastUsed, favorite: p.favorite, body: p.body };
			});
			content = JSON.stringify(exportData, null, 2);
		} else if (format === "csv") {
			filename = "prompto-library.csv";
			var rows = ['"Name","Category","Tags","Variables","Rating","Last Used","Favorite","Body"'];
			for (var i = 0; i < data.length; i++) {
				var p = data[i];
				rows.push('"' + p.name.replace(/"/g, '""') + '","' + p.category + '","' + p.tags.join("; ") + '","' + p.variables.join("; ") + '",' + p.effectiveness + ',"' + (p.lastUsed || "") + '",' + p.favorite + ',"' + p.body.replace(/"/g, '""').replace(/\n/g, "\\n") + '"');
			}
			content = rows.join("\n");
		} else if (format === "md") {
			filename = "prompto-library-export.md";
			var lines = ["# Prompto Library Export", "", "Exported: " + new Date().toISOString().slice(0, 10), "", "---", ""];
			for (var i = 0; i < data.length; i++) {
				var p = data[i];
				lines.push("## " + p.name);
				lines.push("- **Category:** " + p.category);
				lines.push("- **Tags:** " + p.tags.join(", "));
				if (p.variables.length > 0) lines.push("- **Variables:** " + p.variables.map(function(v) { return "{{" + v + "}}"; }).join(", "));
				lines.push("- **Rating:** " + (p.effectiveness || "unrated"));
				lines.push("- **Last Used:** " + (p.lastUsed || "never"));
				lines.push("");
				lines.push("```");
				lines.push(p.body);
				lines.push("```");
				lines.push("");
				lines.push("---");
				lines.push("");
			}
			content = lines.join("\n");
		} else if (format === "yaml") {
			filename = "prompto-library.yaml";
			var yLines = ["# Prompto Library Export", "# Exported: " + new Date().toISOString().slice(0, 10), "", "prompts:"];
			for (var i = 0; i < data.length; i++) {
				var p = data[i];
				yLines.push("  - name: \"" + p.name.replace(/"/g, '\\"') + "\"");
				yLines.push("    category: " + p.category);
				yLines.push("    tags: [" + p.tags.join(", ") + "]");
				yLines.push("    variables: [" + p.variables.join(", ") + "]");
				yLines.push("    icon: " + (p.icon || "file-text"));
				yLines.push("    effectiveness: " + p.effectiveness);
				yLines.push("    lastUsed: \"" + (p.lastUsed || "") + "\"");
				yLines.push("    favorite: " + p.favorite);
				yLines.push("    body: |");
				var bodyLines = p.body.split("\n");
				for (var bi = 0; bi < bodyLines.length; bi++) yLines.push("      " + bodyLines[bi]);
				yLines.push("");
			}
			content = yLines.join("\n");
		} else if (format === "pdf") {
			filename = "prompto-library-export.html";
			var stars = function(n) { return "\u2605".repeat(Math.round(n)) + "\u2606".repeat(5 - Math.round(n)); };
			var esc = function(s) { return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); };
			var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Prompto Library</title><style>';
			html += 'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;max-width:900px;margin:0 auto;padding:40px 20px;color:#1a1a1a;line-height:1.6}';
			html += 'h1{font-size:24px;border-bottom:2px solid #7c3aed;padding-bottom:8px;color:#7c3aed}';
			html += '.meta{font-size:12px;color:#666;margin-bottom:30px}';
			html += '.prompt{border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:16px;page-break-inside:avoid}';
			html += '.prompt h2{font-size:16px;margin:0 0 8px;color:#1a1a1a}';
			html += '.prompt-meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;font-size:12px}';
			html += '.cat{background:#7c3aed;color:#fff;padding:2px 8px;border-radius:4px;font-weight:600}';
			html += '.tag{background:#e5e7eb;color:#666;padding:2px 6px;border-radius:4px}';
			html += '.stars{color:#7c3aed;font-size:13px}';
			html += '.body{background:#f9fafb;border-radius:6px;padding:12px;font-family:monospace;font-size:13px;white-space:pre-wrap;word-wrap:break-word}';
			html += '.date{font-size:11px;color:#999;margin-top:6px}';
			html += '@media print{body{padding:10px}.prompt{border:1px solid #ccc}}';
			html += '</style></head><body>';
			html += '<h1>Prompto Library</h1>';
			html += '<p class="meta">Exported ' + new Date().toISOString().slice(0, 10) + ' \u2014 ' + data.length + ' prompts \u2014 Open this file in a browser and use Print (Ctrl+P) \u2192 Save as PDF</p>';
			for (var i = 0; i < data.length; i++) {
				var p = data[i];
				html += '<div class="prompt">';
				html += '<h2>' + esc(p.name) + '</h2>';
				html += '<div class="prompt-meta"><span class="cat">' + esc(p.category) + '</span>';
				for (var t = 0; t < p.tags.length; t++) html += '<span class="tag">' + esc(p.tags[t]) + '</span>';
				if (p.effectiveness > 0) html += '<span class="stars">' + stars(p.effectiveness) + ' ' + p.effectiveness + '</span>';
				html += '</div>';
				html += '<div class="body">' + esc(p.body) + '</div>';
				if (p.lastUsed) html += '<div class="date">Last used: ' + p.lastUsed + '</div>';
				html += '</div>';
			}
			html += '</body></html>';
			content = html;
		}

		// Save to vault
		var exportPath = this.plugin.settings.libraryPath + "/" + filename;
		var existing = this.app.vault.getAbstractFileByPath(exportPath);
		if (existing instanceof obsidian.TFile) await this.app.vault.modify(existing, content);
		else await this.app.vault.create(exportPath, content);
		new obsidian.Notice("Exported " + data.length + " prompts to " + exportPath);

		// Open the file
		var file = this.app.vault.getAbstractFileByPath(exportPath);
		if (file instanceof obsidian.TFile) this.app.workspace.getLeaf(false).openFile(file);
	}

	async importJSON() {
		var self = this;
		var input = document.createElement("input");
		input.type = "file";
		input.accept = ".json";
		input.addEventListener("change", async function() {
			if (!input.files || !input.files[0]) return;
			var reader = new FileReader();
			reader.onload = async function(e) {
				try {
					var imported = JSON.parse(e.target.result);
					if (!Array.isArray(imported)) { new obsidian.Notice("Invalid format. Expected a JSON array."); return; }
					var count = 0;
					for (var i = 0; i < imported.length; i++) {
						var p = imported[i];
						if (!p.name || !p.body) continue;
						var tags = Array.isArray(p.tags) ? p.tags : [];
						var vars = Array.isArray(p.variables) ? p.variables : [];
						var fm = "---\n";
						fm += 'name: "' + (p.name || "Imported Prompt") + '"\n';
						fm += "category: " + (p.category || "Writing") + "\n";
						fm += "tags: [" + tags.join(", ") + "]\n";
						fm += "variables: [" + vars.join(", ") + "]\n";
						fm += "version: 1\n";
						fm += "effectiveness: " + (p.effectiveness || 0) + "\n";
						fm += 'lastUsed: "' + (p.lastUsed || new Date().toISOString().slice(0, 10)) + '"\n';
						fm += 'icon: "' + (p.icon || "file-text") + '"\n';
						fm += "favorite: " + (p.favorite || false) + "\n";
						fm += "---\n\n";
						fm += p.body;

						var filePath = self.plugin.settings.libraryPath + "/" + p.name.replace(/[\\/:*?"<>|]/g, "-") + ".md";
						var exists = self.app.vault.getAbstractFileByPath(filePath);
						if (exists instanceof obsidian.TFile) await self.app.vault.modify(exists, fm);
						else await self.app.vault.create(filePath, fm);
						count++;
					}
					new obsidian.Notice("Imported " + count + " prompt(s)!");
					await self.loadPrompts();
					self.render();
				} catch (err) {
					new obsidian.Notice("Import failed: " + (err instanceof Error ? err.message : "Error"));
				}
			};
			reader.readAsText(input.files[0]);
		});
		input.click();
	}

	onClose() { this.contentEl.empty(); }
}

// ═══ SIDEBAR VIEW ═══════════════════════════════════════

class PromptLibraryView extends obsidian.ItemView {
	constructor(leaf, plugin) {
		super(leaf); this.plugin = plugin;
		this.prompts = []; this.filteredPrompts = [];
		this.activeCategory = "All"; this.searchQuery = ""; this.cardsContainer = null;
	}
	getViewType() { return VIEW_TYPE_PROMPTO; }
	getDisplayText() { return "Prompto"; }
	getIcon() { return "target"; }
	async onOpen() { await this.loadPrompts(); this.buildUI(); }
	async onClose() { this.contentEl.empty(); }

	async loadPrompts() {
		this.prompts = [];
		var folder = this.app.vault.getAbstractFileByPath(this.plugin.settings.libraryPath);
		if (!(folder instanceof obsidian.TFolder)) { console.log("Prompto: Library folder not found at '" + this.plugin.settings.libraryPath + "'"); return; }
		console.log("Prompto: Scanning '" + this.plugin.settings.libraryPath + "' — " + folder.children.length + " items");
		for (var i = 0; i < folder.children.length; i++) {
			var child = folder.children[i];
			if (child instanceof obsidian.TFile && child.extension === "md" && !child.basename.startsWith("_")) {
				var pf = await parsePromptFile(this.app, child);
				if (pf) { console.log("Prompto: \u2705 " + pf.name); this.prompts.push(pf); }
				else console.log("Prompto: \u274C Skipped: " + child.path);
			}
		}
		console.log("Prompto: Loaded " + this.prompts.length + " prompts");
		this.prompts.sort(function(a, b) {
			// Favorites always float to top
			if (a.favorite && !b.favorite) return -1;
			if (!a.favorite && b.favorite) return 1;
			return b.effectiveness - a.effectiveness || a.name.localeCompare(b.name);
		});
		this.applyFilters();
	}

	applyFilters() {
		var self = this;
		this.filteredPrompts = this.prompts.filter(function(p) {
			if (self.activeCategory !== "All" && self.activeCategory !== "Favorites" && p.category !== self.activeCategory) return false;
			if (self.searchQuery) {
				var q = self.searchQuery.toLowerCase();
				return p.name.toLowerCase().indexOf(q) !== -1 || p.tags.some(function(t) { return t.toLowerCase().indexOf(q) !== -1; }) || p.category.toLowerCase().indexOf(q) !== -1 || p.body.toLowerCase().indexOf(q) !== -1;
			}
			return true;
		});
		// When Favorites is active, sort favorites to top but show everything
		if (self.activeCategory === "Favorites") {
			this.filteredPrompts.sort(function(a, b) {
				if (a.favorite && !b.favorite) return -1;
				if (!a.favorite && b.favorite) return 1;
				return b.effectiveness - a.effectiveness || a.name.localeCompare(b.name);
			});
		}
	}

	buildUI() {
		var self = this, el = this.contentEl;
		el.empty(); el.addClass("prompto-sidebar");
		var hd = el.createDiv({ cls: "prompto-sidebar-header" });
		var tr = hd.createDiv({ cls: "prompto-title-row" });
		obsidian.setIcon(tr.createSpan({ cls: "prompto-title-icon" }), "target");
		tr.createEl("h3", { text: "Prompto" });
		tr.createSpan({ cls: "prompto-count-badge", text: String(this.prompts.length) });
		// New Prompt button
		var newBtn = tr.createEl("button", { cls: "prompto-btn-new", title: "Create new prompt" });
		obsidian.setIcon(newBtn, "plus");
		newBtn.addEventListener("click", function() {
			new CreatePromptModal(self.app, self.plugin.settings, null, function() { self.refresh(); }).open();
		});
		// Manage Library button
		var manageBtn = tr.createEl("button", { cls: "prompto-btn-new prompto-btn-manage", title: "Manage prompt library" });
		obsidian.setIcon(manageBtn, "library");
		manageBtn.addEventListener("click", function() {
			new ManageModal(self.app, self.plugin).open();
		});
		// Settings button
		var settingsBtn = tr.createEl("button", { cls: "prompto-btn-new prompto-btn-manage", title: "Prompto settings" });
		obsidian.setIcon(settingsBtn, "settings");
		settingsBtn.addEventListener("click", function() {
			self.app.setting.open();
			self.app.setting.openTabById("prompto");
		});
		// Search
		var sw = hd.createDiv({ cls: "prompto-search-wrap" });
		obsidian.setIcon(sw.createSpan({ cls: "prompto-search-icon" }), "search");
		var si = sw.createEl("input", { type: "text", placeholder: "Search prompts...", cls: "prompto-search-input" });
		si.addEventListener("input", function() { self.searchQuery = si.value; self.applyFilters(); self.renderCards(); });
		// Category filter row: All button + Favorites button + dropdown
		var filterRow = hd.createDiv({ cls: "prompto-filter-row" });

		var allBtn = filterRow.createEl("button", { cls: "prompto-filter-btn" + (this.activeCategory === "All" ? " prompto-filter-btn-active" : "") });
		obsidian.setIcon(allBtn.createSpan({ cls: "prompto-tab-icon" }), "layout-grid");
		allBtn.createSpan({ text: " All" });
		allBtn.addEventListener("click", function() {
			self.activeCategory = "All";
			allBtn.addClass("prompto-filter-btn-active");
			favBtn.removeClass("prompto-filter-btn-active");
			catDrop.setValue(""); 
			self.applyFilters(); self.renderCards();
		});

		var favBtn = filterRow.createEl("button", { cls: "prompto-filter-btn" + (this.activeCategory === "Favorites" ? " prompto-filter-btn-active" : "") });
		obsidian.setIcon(favBtn.createSpan({ cls: "prompto-tab-icon" }), "flag");
		favBtn.createSpan({ text: " Favorites" });
		favBtn.addEventListener("click", function() {
			self.activeCategory = "Favorites";
			favBtn.addClass("prompto-filter-btn-active");
			allBtn.removeClass("prompto-filter-btn-active");
			catDrop.setValue("");
			self.applyFilters(); self.renderCards();
		});

		// Category dropdown
		var catSelect = filterRow.createEl("select", { cls: "prompto-filter-select" });
		catSelect.createEl("option", { text: "Category...", attr: { value: "" } });
		// Collect unique categories from loaded prompts
		var seenCats = {};
		for (var ci = 0; ci < this.prompts.length; ci++) {
			if (!seenCats[this.prompts[ci].category]) {
				catSelect.createEl("option", { text: this.prompts[ci].category, attr: { value: this.prompts[ci].category } });
				seenCats[this.prompts[ci].category] = true;
			}
		}
		// Also add standard categories if not already present
		var stdCats = ["Writing", "Coding", "Research", "Product", "Daily"];
		for (var sc = 0; sc < stdCats.length; sc++) {
			if (!seenCats[stdCats[sc]]) catSelect.createEl("option", { text: stdCats[sc], attr: { value: stdCats[sc] } });
		}
		if (this.activeCategory !== "All" && this.activeCategory !== "Favorites") catSelect.value = this.activeCategory;
		catSelect.addEventListener("change", function() {
			var v = catSelect.value;
			if (v) {
				self.activeCategory = v;
				allBtn.removeClass("prompto-filter-btn-active");
				favBtn.removeClass("prompto-filter-btn-active");
			} else {
				self.activeCategory = "All";
				allBtn.addClass("prompto-filter-btn-active");
			}
			self.applyFilters(); self.renderCards();
		});

		this.cardsContainer = el.createDiv({ cls: "prompto-cards" });
		this.renderCards();
	}

	renderCards() {
		if (!this.cardsContainer) return;
		this.cardsContainer.empty();
		if (this.filteredPrompts.length === 0) {
			var emp = this.cardsContainer.createDiv({ cls: "prompto-empty" });
			obsidian.setIcon(emp.createDiv({ cls: "prompto-empty-icon" }), "inbox");
			emp.createEl("p", { text: "No prompts found." });
			if (this.prompts.length === 0) emp.createEl("p", { text: "Add .md files with Prompto frontmatter to your library folder.", cls: "prompto-empty-hint" });
			return;
		}
		for (var i = 0; i < this.filteredPrompts.length; i++) this.renderCard(this.filteredPrompts[i]);
	}

	renderCard(prompt) {
		if (!this.cardsContainer) return;
		var self = this;
		var card = this.cardsContainer.createDiv({ cls: "prompto-card" });
		card.addEventListener("click", function() { new PreviewModal(self.app, prompt, self.plugin.settings).open(); });
		var ch = card.createDiv({ cls: "prompto-card-header" });
		obsidian.setIcon(ch.createSpan({ cls: "prompto-card-icon" }), prompt.icon || "file-text");
		ch.createEl("span", { text: prompt.name, cls: "prompto-card-title" });
		var meta = card.createDiv({ cls: "prompto-card-meta" });
		meta.createSpan({ cls: "prompto-card-category", text: prompt.category });
		for (var ti = 0; ti < Math.min(prompt.tags.length, 3); ti++) meta.createSpan({ cls: "prompto-card-tag", text: prompt.tags[ti] });
		card.createDiv({ cls: "prompto-card-body", text: prompt.body.slice(0, 100).replace(/\n/g, " ") + (prompt.body.length > 100 ? "\u2026" : "") });
		var ft = card.createDiv({ cls: "prompto-card-footer" });
		if (prompt.effectiveness > 0) ft.createSpan({ cls: "prompto-card-stars", text: "\u2605".repeat(Math.round(prompt.effectiveness)) + "\u2606".repeat(5 - Math.round(prompt.effectiveness)) + " " + prompt.effectiveness });
		if (prompt.lastUsed) ft.createSpan({ cls: "prompto-card-date", text: prompt.lastUsed });
		var fav = card.createDiv({ cls: "prompto-card-fav" });
		obsidian.setIcon(fav, prompt.favorite ? "flag" : "flag-off");
		fav.addEventListener("click", async function(e) {
			e.stopPropagation(); prompt.favorite = !prompt.favorite;
			await updateFrontmatterField(self.app, prompt.path, "favorite", prompt.favorite);
			// Re-sort so favorites float to top
			self.prompts.sort(function(a, b) {
				if (a.favorite && !b.favorite) return -1;
				if (!a.favorite && b.favorite) return 1;
				return b.effectiveness - a.effectiveness || a.name.localeCompare(b.name);
			});
			self.applyFilters();
			self.renderCards();
		});
		// Edit and Open buttons
		var cardActions = card.createDiv({ cls: "prompto-card-actions" });
		var editBtn = cardActions.createEl("button", { cls: "prompto-card-action-btn", title: "Edit prompt" });
		obsidian.setIcon(editBtn, "pencil");
		editBtn.addEventListener("click", function(e) {
			e.stopPropagation();
			new CreatePromptModal(self.app, self.plugin.settings, prompt, function() { self.refresh(); }).open();
		});
		var openBtn = cardActions.createEl("button", { cls: "prompto-card-action-btn", title: "Open file" });
		obsidian.setIcon(openBtn, "file-text");
		openBtn.addEventListener("click", function(e) {
			e.stopPropagation();
			var file = self.app.vault.getAbstractFileByPath(prompt.path);
			if (file instanceof obsidian.TFile) self.app.workspace.getLeaf(false).openFile(file);
		});
	}

	async refresh() { await this.loadPrompts(); this.buildUI(); }
}

// ═══ SETTINGS TAB ═══════════════════════════════════════

class PromptoSettingTab extends obsidian.PluginSettingTab {
	constructor(app, plugin) { super(app, plugin); this.plugin = plugin; }
	display() {
		var el = this.containerEl, p = this.plugin;
		el.empty();
		el.createEl("h1", { text: "Prompto Settings" });
		el.createEl("p", { text: "Configure your prompt library, API keys, and default behaviors.", cls: "setting-item-description" });

		el.createEl("h2", { text: "Library" });
		new obsidian.Setting(el).setName("Library folder path").setDesc("Vault-relative path. Created automatically if missing.")
			.addText(function(t) { t.setPlaceholder("Prompto Library").setValue(p.settings.libraryPath).onChange(async function(v) { p.settings.libraryPath = v || "Prompto Library"; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Generate index file").setDesc("Auto-generate _Prompto Index.md with stats.")
			.addToggle(function(t) { t.setValue(p.settings.generateIndex).onChange(async function(v) { p.settings.generateIndex = v; await p.saveSettings(); }); });

		el.createEl("h2", { text: "API Keys" });
		el.createEl("p", { text: "Keys are stored locally in plugin data. Only configure providers you use.", cls: "setting-item-description" });

		new obsidian.Setting(el).setName("Grok / xAI API key").setDesc("Get yours at console.x.ai")
			.addText(function(t) { t.setPlaceholder("xai-...").setValue(p.settings.grokApiKey).onChange(async function(v) { p.settings.grokApiKey = v.trim(); await p.saveSettings(); }); t.inputEl.type = "password"; });
		new obsidian.Setting(el).setName("Claude / Anthropic API key").setDesc("Get yours at console.anthropic.com")
			.addText(function(t) { t.setPlaceholder("sk-ant-...").setValue(p.settings.claudeApiKey).onChange(async function(v) { p.settings.claudeApiKey = v.trim(); await p.saveSettings(); }); t.inputEl.type = "password"; });
		new obsidian.Setting(el).setName("OpenAI API key").setDesc("Get yours at platform.openai.com")
			.addText(function(t) { t.setPlaceholder("sk-...").setValue(p.settings.openaiApiKey).onChange(async function(v) { p.settings.openaiApiKey = v.trim(); await p.saveSettings(); }); t.inputEl.type = "password"; });
		new obsidian.Setting(el).setName("Venice.ai API key").setDesc("Get yours at venice.ai — privacy-first, OpenAI-compatible")
			.addText(function(t) { t.setPlaceholder("venice-...").setValue(p.settings.veniceApiKey).onChange(async function(v) { p.settings.veniceApiKey = v.trim(); await p.saveSettings(); }); t.inputEl.type = "password"; });
		new obsidian.Setting(el).setName("Venice.ai model").setDesc("Model name (e.g. llama-3.3-70b, deepseek-r1, venice-uncensored)")
			.addText(function(t) { t.setPlaceholder("llama-3.3-70b").setValue(p.settings.veniceModel).onChange(async function(v) { p.settings.veniceModel = v.trim() || "llama-3.3-70b"; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Ollama base URL").setDesc("Local Ollama instance URL")
			.addText(function(t) { t.setPlaceholder("http://localhost:11434").setValue(p.settings.ollamaUrl).onChange(async function(v) { p.settings.ollamaUrl = v.trim() || "http://localhost:11434"; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Ollama model").setDesc("Model name for Ollama")
			.addText(function(t) { t.setPlaceholder("llama3").setValue(p.settings.ollamaModel).onChange(async function(v) { p.settings.ollamaModel = v.trim() || "llama3"; await p.saveSettings(); }); });

		el.createEl("h2", { text: "Defaults" });
		var opts = { grok: "Grok (xAI)", claude: "Claude (Anthropic)", openai: "GPT-4o (OpenAI)", venice: "Venice.ai", ollama: "Ollama (Local)" };
		new obsidian.Setting(el).setName("Default refiner model").setDesc("Which LLM adapts your prompts with context.")
			.addDropdown(function(d) { d.addOptions(opts).setValue(p.settings.defaultRefiner).onChange(async function(v) { p.settings.defaultRefiner = v; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Default send-to model").setDesc("Default destination when you click Send.")
			.addDropdown(function(d) { d.addOptions(opts).setValue(p.settings.defaultSendTo).onChange(async function(v) { p.settings.defaultSendTo = v; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Auto-detect context").setDesc("Gather context from active note, selection, and backlinks.")
			.addToggle(function(t) { t.setValue(p.settings.autoDetectContext).onChange(async function(v) { p.settings.autoDetectContext = v; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Auto-adapt prompts").setDesc("Automatically run the refiner when opening a prompt card.")
			.addToggle(function(t) { t.setValue(p.settings.autoAdapt).onChange(async function(v) { p.settings.autoAdapt = v; await p.saveSettings(); }); });
		new obsidian.Setting(el).setName("Max context characters").setDesc("Max chars of context sent to refiner.")
			.addText(function(t) { t.setPlaceholder("4000").setValue(String(p.settings.maxContextChars)).onChange(async function(v) { var n = parseInt(v, 10); p.settings.maxContextChars = isNaN(n) ? 4000 : n; await p.saveSettings(); }); });
	}
}

// ═══ MAIN PLUGIN ════════════════════════════════════════

class PromptoPlugin extends obsidian.Plugin {
	constructor() { super(...arguments); this.settings = Object.assign({}, DEFAULT_SETTINGS); }

	async onload() {
		console.log("Prompto: Loading...");
		await this.loadSettings();
		var self = this;
		this.registerView(VIEW_TYPE_PROMPTO, function(leaf) { return new PromptLibraryView(leaf, self); });
		this.injectStyles();
		this.addRibbonIcon("target", "Open Prompto Library", function() { self.activateView(); });
		this.addCommand({ id: "open-prompto-library", name: "Open Prompto Library", callback: function() { self.activateView(); } });
		this.addCommand({ id: "save-chat-as-prompt", name: "Save current note as new prompt", editorCallback: async function(editor) {
			var view = self.app.workspace.getActiveViewOfType(obsidian.MarkdownView); await self.saveCurrentAsPrompt(editor, view);
		}});
		this.addCommand({ id: "generate-prompto-index", name: "Generate Prompto Index", callback: function() { self.generateIndex(); } });
		this.addCommand({ id: "refresh-prompto-library", name: "Refresh Prompto Library", callback: async function() {
			await self.refreshView(); new obsidian.Notice("Prompto: Refreshed! " + self.getPromptCount() + " prompts loaded.");
		}});
		this.addCommand({ id: "manage-prompto-library", name: "Manage Prompt Library", callback: function() {
			new ManageModal(self.app, self).open();
		}});
		this.addSettingTab(new PromptoSettingTab(this.app, this));
		this.app.workspace.onLayoutReady(async function() { await self.ensureLibraryFolder(); if (self.settings.generateIndex) await self.generateIndex(); console.log("Prompto: Ready!"); });
	}

	getPromptCount() {
		var leaves = this.app.workspace.getLeavesOfType(VIEW_TYPE_PROMPTO);
		for (var i = 0; i < leaves.length; i++) if (leaves[i].view instanceof PromptLibraryView) return leaves[i].view.prompts.length;
		return 0;
	}

	onunload() { this.app.workspace.detachLeavesOfType(VIEW_TYPE_PROMPTO); }

	async activateView() {
		var leaves = this.app.workspace.getLeavesOfType(VIEW_TYPE_PROMPTO);
		if (leaves.length > 0) { this.app.workspace.revealLeaf(leaves[0]); return; }
		var rl = this.app.workspace.getRightLeaf(false);
		if (rl) { await rl.setViewState({ type: VIEW_TYPE_PROMPTO, active: true }); this.app.workspace.revealLeaf(rl); }
	}

	async ensureLibraryFolder() {
		if (!this.app.vault.getAbstractFileByPath(this.settings.libraryPath)) {
			await this.app.vault.createFolder(this.settings.libraryPath);
			new obsidian.Notice('Prompto: Created "' + this.settings.libraryPath + '"');
		}
	}

	async saveCurrentAsPrompt(editor, view) {
		var text = editor.getSelection() || editor.getValue();
		var title = (view && view.file) ? view.file.basename : "New Prompt";
		var fp = this.settings.libraryPath + "/" + title + ".md";
		if (this.app.vault.getAbstractFileByPath(fp)) { new obsidian.Notice('"' + title + '" already exists.'); return; }
		await this.ensureLibraryFolder();
		var fm = "---\nname: \"" + title + "\"\ncategory: Daily\ntags: [custom]\nvariables: []\nversion: 1\neffectiveness: 0\nlastUsed: \"" + new Date().toISOString().slice(0, 10) + "\"\nicon: \"file-text\"\n---";
		await this.app.vault.create(fp, fm + "\n\n" + text);
		new obsidian.Notice('Saved "' + title + '" to Prompto Library!'); await this.refreshView();
	}

	async generateIndex() {
		var folder = this.app.vault.getAbstractFileByPath(this.settings.libraryPath);
		if (!(folder instanceof obsidian.TFolder)) return;
		var prompts = [];
		for (var i = 0; i < folder.children.length; i++) {
			var c = folder.children[i];
			if (c instanceof obsidian.TFile && c.extension === "md" && !c.basename.startsWith("_")) { var pf = await parsePromptFile(this.app, c); if (pf) prompts.push(pf); }
		}
		var content = generateIndexContent(prompts);
		var ip = this.settings.libraryPath + "/_Prompto Index.md";
		var ex = this.app.vault.getAbstractFileByPath(ip);
		if (ex instanceof obsidian.TFile) await this.app.vault.modify(ex, content);
		else await this.app.vault.create(ip, content);
	}

	async refreshView() {
		var leaves = this.app.workspace.getLeavesOfType(VIEW_TYPE_PROMPTO);
		for (var i = 0; i < leaves.length; i++) if (leaves[i].view instanceof PromptLibraryView) await leaves[i].view.refresh();
	}

	async loadSettings() { this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData()); }
	async saveSettings() { await this.saveData(this.settings); }

	injectStyles() {
		var css = ".prompto-sidebar{padding:0;height:100%;display:flex;flex-direction:column;overflow:hidden}.prompto-sidebar-header{padding:12px 12px 8px;border-bottom:1px solid var(--background-modifier-border);flex-shrink:0}.prompto-title-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}.prompto-title-row h3{margin:0;font-size:16px;font-weight:600}.prompto-title-icon{display:flex;align-items:center}.prompto-title-icon svg{width:18px;height:18px;color:var(--text-accent)}.prompto-count-badge{background:var(--interactive-accent);color:var(--text-on-accent);padding:1px 7px;border-radius:10px;font-size:11px;font-weight:600;margin-left:auto}.prompto-search-wrap{display:flex;align-items:center;background:var(--background-secondary);border-radius:6px;padding:4px 8px;margin-bottom:8px}.prompto-search-icon{display:flex;margin-right:6px}.prompto-search-icon svg{width:14px;height:14px;color:var(--text-muted)}.prompto-search-input{border:none;background:transparent;width:100%;font-size:13px;color:var(--text-normal);outline:none}.prompto-search-input::placeholder{color:var(--text-faint)}.prompto-tabs{display:flex;gap:2px;overflow-x:auto;padding-bottom:4px}.prompto-tabs::-webkit-scrollbar{height:0}.prompto-tab{display:flex;align-items:center;gap:3px;padding:4px 8px;border-radius:6px;border:none;background:transparent;color:var(--text-muted);font-size:11px;cursor:pointer;white-space:nowrap;transition:background .15s,color .15s}.prompto-tab:hover{background:var(--background-modifier-hover);color:var(--text-normal)}.prompto-tab-active{background:var(--interactive-accent)!important;color:var(--text-on-accent)!important}.prompto-tab-icon{display:flex}.prompto-tab-icon svg{width:12px;height:12px}.prompto-filter-row{display:flex;align-items:center;gap:6px;padding-bottom:4px}.prompto-filter-btn{display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:6px;border:1px solid var(--background-modifier-border);background:var(--background-secondary);color:var(--text-muted);font-size:12px;cursor:pointer;white-space:nowrap;transition:background .15s,color .15s,border-color .15s}.prompto-filter-btn:hover{background:var(--background-modifier-hover);color:var(--text-normal)}.prompto-filter-btn-active{background:var(--interactive-accent)!important;color:var(--text-on-accent)!important;border-color:var(--interactive-accent)!important}.prompto-filter-select{padding:5px 8px;font-size:12px;border-radius:6px;border:1px solid var(--background-modifier-border);background:var(--background-secondary);color:var(--text-normal);cursor:pointer;outline:none;height:30px}.prompto-cards{flex:1;overflow-y:auto;padding:8px 12px;display:flex;flex-direction:column;gap:8px}.prompto-card{background:var(--background-secondary);border:1px solid var(--background-modifier-border);border-radius:8px;padding:12px;cursor:pointer;transition:border-color .15s,box-shadow .15s;position:relative}.prompto-card:hover{border-color:var(--interactive-accent);box-shadow:0 2px 8px rgba(0,0,0,.08)}.prompto-card-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}.prompto-card-icon{display:flex;flex-shrink:0}.prompto-card-icon svg{width:16px;height:16px;color:var(--text-accent)}.prompto-card-title{font-weight:600;font-size:13px;color:var(--text-normal);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.prompto-card-meta{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px}.prompto-card-category{background:var(--interactive-accent);color:var(--text-on-accent);padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600}.prompto-card-tag{background:var(--background-modifier-border);color:var(--text-muted);padding:1px 6px;border-radius:4px;font-size:10px}.prompto-card-body{font-size:12px;color:var(--text-muted);line-height:1.4;margin-bottom:6px}.prompto-card-footer{display:flex;justify-content:space-between;align-items:center}.prompto-card-stars{font-size:11px;color:var(--text-accent)}.prompto-card-date{font-size:10px;color:var(--text-faint)}.prompto-card-fav{position:absolute;top:8px;right:8px;cursor:pointer;display:flex}.prompto-card-fav svg{width:14px;height:14px;color:var(--text-accent)}.prompto-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:var(--text-muted)}.prompto-empty-icon svg{width:40px;height:40px;color:var(--text-faint)}.prompto-empty p{margin:8px 0 0;font-size:13px}.prompto-empty-hint{font-size:11px;color:var(--text-faint)}.prompto-preview-modal{max-width:900px!important;width:90vw!important;overflow:hidden!important}.prompto-modal-titlebar{display:flex;align-items:center;gap:10px;margin-bottom:16px;border-bottom:1px solid var(--background-modifier-border);padding-bottom:12px}.prompto-modal-titlebar h2{margin:0;font-size:18px}.prompto-modal-icon{display:flex}.prompto-modal-icon svg{width:22px;height:22px;color:var(--text-accent)}.prompto-category-badge{background:var(--interactive-accent);color:var(--text-on-accent);padding:2px 10px;border-radius:12px;font-size:11px;font-weight:600}.prompto-columns{display:flex;gap:16px;min-height:300px}.prompto-col-left{flex:1;border-right:1px solid var(--background-modifier-border);padding-right:16px;overflow-y:auto;overflow-x:hidden;max-height:70vh}.prompto-col-right{width:240px;flex-shrink:0;overflow-y:auto;max-height:70vh}.prompto-col-left h3,.prompto-col-right h3{font-size:13px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin:0 0 10px}.prompto-preview-content{font-size:14px;line-height:1.6}.prompto-vars{margin-bottom:16px}.prompto-var-group{margin-bottom:10px}.prompto-var-label{display:block;font-size:12px;font-weight:600;color:var(--text-normal);margin-bottom:4px;text-transform:capitalize}.prompto-var-input{width:100%;resize:vertical;font-size:13px}.prompto-context-summary{background:var(--background-secondary);border-radius:6px;padding:10px;margin-bottom:16px}.prompto-ctx-item{font-size:12px;color:var(--text-normal);margin-bottom:4px;line-height:1.4}.prompto-ctx-empty{color:var(--text-faint);font-style:italic}.prompto-actions{display:flex;flex-direction:column;gap:6px;margin-bottom:16px}.prompto-btn{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:6px;border:1px solid var(--background-modifier-border);background:var(--background-secondary);color:var(--text-normal);font-size:13px;cursor:pointer;transition:background .15s,border-color .15s}.prompto-btn:hover{background:var(--background-modifier-hover);border-color:var(--interactive-accent)}.prompto-btn svg{width:14px;height:14px}.prompto-btn-primary,.prompto-btn-adapt{background:var(--interactive-accent);color:var(--text-on-accent);border-color:var(--interactive-accent)}.prompto-btn-primary:hover,.prompto-btn-adapt:hover{opacity:.9}.prompto-btn-loading{opacity:.6;pointer-events:none}.prompto-btn-disabled{opacity:.4;cursor:not-allowed}.prompto-send-buttons{display:grid;grid-template-columns:1fr 1fr;gap:6px}.prompto-send-btn{font-size:11px;padding:6px 6px;justify-content:center}.prompto-response-modal{max-width:900px;width:90vw}.prompto-response-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}.prompto-response-header h2{margin:0}.prompto-header-icon{display:inline-flex;margin-right:4px}.prompto-header-icon svg{width:20px;height:20px}.prompto-response-content{background:var(--background-secondary);border-radius:8px;padding:16px;max-height:50vh;overflow-y:auto;margin-bottom:16px;font-size:14px;line-height:1.6}.prompto-response-actions{display:flex;gap:8px;margin-bottom:16px}.prompto-rating-section{text-align:center}.prompto-rating-section h3{font-size:14px;margin-bottom:8px}.prompto-stars{display:flex;justify-content:center;gap:8px}.prompto-star-btn{background:none;border:none;cursor:pointer;padding:4px;transition:transform .15s}.prompto-star-btn:hover{transform:scale(1.3)}.prompto-star-btn svg{width:24px;height:24px;color:var(--text-accent)}@media(max-width:600px){.prompto-columns{flex-direction:column}.prompto-col-left{border-right:none;border-bottom:1px solid var(--background-modifier-border);padding-right:0;padding-bottom:16px;max-height:40vh}.prompto-col-right{width:100%}.prompto-send-buttons{grid-template-columns:1fr}.prompto-preview-modal,.prompto-response-modal{width:95vw}}.prompto-btn-new{display:flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:6px;border:1px solid var(--background-modifier-border);background:var(--interactive-accent);color:var(--text-on-accent);cursor:pointer;padding:0;margin-left:4px;transition:opacity .15s}.prompto-btn-new:hover{opacity:.85}.prompto-btn-new svg{width:14px;height:14px}.prompto-card-actions{display:flex;gap:4px;position:absolute;top:8px;right:30px}.prompto-card-action-btn{display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:4px;border:none;background:var(--background-modifier-border);color:var(--text-muted);cursor:pointer;padding:0;opacity:0;transition:opacity .15s}.prompto-card:hover .prompto-card-action-btn{opacity:1}.prompto-card-action-btn:hover{background:var(--interactive-accent);color:var(--text-on-accent)}.prompto-card-action-btn svg{width:12px;height:12px}.prompto-create-modal{max-width:521px;width:55vw;height:85vh}.prompto-create-modal .modal-content{height:100%;overflow-y:auto;overflow-x:hidden;padding-bottom:16px}.prompto-create-modal h2{margin:0 0 16px;font-size:18px}.prompto-form-group{margin-bottom:10px}.prompto-form-label{display:block;font-size:13px;font-weight:600;color:var(--text-normal);margin-bottom:4px}.prompto-form-input{width:100%;padding:6px 10px;border:1px solid var(--background-modifier-border);border-radius:6px;background:var(--background-secondary);color:var(--text-normal);font-size:13px;outline:none;box-sizing:border-box}.prompto-form-input:focus{border-color:var(--interactive-accent)}.prompto-form-dropdown{width:100%;padding:6px 10px;border-radius:6px;font-size:13px}.prompto-form-textarea{width:100%;min-height:150px;font-family:var(--font-monospace);font-size:13px;line-height:1.5;box-sizing:border-box}.prompto-form-hint{font-size:11px;color:var(--text-faint);margin-top:4px}.prompto-how-it-works{margin-top:8px;padding:8px 10px;background:var(--background-secondary);border-radius:6px;border-left:3px solid var(--interactive-accent);line-height:1.5}.prompto-form-custom-cat{margin-top:6px}.prompto-chip-wrap{display:flex;flex-wrap:wrap;align-items:center;gap:4px;padding:6px 8px;border:1px solid var(--background-modifier-border);border-radius:6px;background:var(--background-secondary);min-height:32px;cursor:text}.prompto-chip-wrap:focus-within{border-color:var(--interactive-accent)}.prompto-chip-container{display:flex;flex-wrap:wrap;gap:4px}.prompto-chip{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:12px;background:var(--interactive-accent);color:var(--text-on-accent);font-size:11px;font-weight:500}.prompto-chip-var{background:var(--background-modifier-border);color:var(--text-normal);font-family:var(--font-monospace);font-size:11px}.prompto-chip-remove{cursor:pointer;font-size:14px;line-height:1;opacity:.7;margin-left:2px}.prompto-chip-remove:hover{opacity:1}.prompto-chip-input{border:none;background:transparent;outline:none;font-size:13px;color:var(--text-normal);flex:1;min-width:120px;padding:2px 0}.prompto-chip-input::placeholder{color:var(--text-faint)}.prompto-var-suggestions{display:flex;flex-wrap:wrap;align-items:center;gap:4px;margin-top:6px}.prompto-var-suggest-btn{padding:2px 8px;border-radius:10px;border:1px dashed var(--background-modifier-border);background:transparent;color:var(--text-muted);font-size:10px;font-family:var(--font-monospace);cursor:pointer;transition:border-color .15s,color .15s}.prompto-var-suggest-btn:hover{border-color:var(--interactive-accent);color:var(--text-accent)}.prompto-chip-wrap{display:flex;flex-wrap:wrap;align-items:center;gap:4px;padding:6px 8px;border:1px solid var(--background-modifier-border);border-radius:6px;background:var(--background-secondary);min-height:34px;cursor:text}.prompto-chip-wrap:focus-within{border-color:var(--interactive-accent)}.prompto-chip-container{display:flex;flex-wrap:wrap;gap:4px}.prompto-chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:12px;background:var(--interactive-accent);color:var(--text-on-accent);font-size:11px;font-weight:500;white-space:nowrap}.prompto-chip-remove{cursor:pointer;font-size:14px;line-height:1;opacity:.7;margin-left:2px}.prompto-chip-remove:hover{opacity:1}.prompto-chip-input{border:none;background:transparent;outline:none;font-size:13px;color:var(--text-normal);flex:1;min-width:100px}.prompto-chip-input::placeholder{color:var(--text-faint)}.prompto-icon-grid{display:grid;grid-template-columns:repeat(auto-fill,32px);gap:4px;padding:6px;border:1px solid var(--background-modifier-border);border-radius:6px;background:var(--background-secondary);max-height:80px;overflow-y:auto}.prompto-icon-btn{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:6px;cursor:pointer;transition:background .15s,border-color .15s;border:2px solid transparent}.prompto-icon-btn:hover{background:var(--background-modifier-hover)}.prompto-icon-btn-active{background:var(--interactive-accent);border-color:var(--interactive-accent)}.prompto-icon-btn-active svg{color:var(--text-on-accent)}.prompto-custom-icon-row{display:flex;align-items:center;gap:6px;margin-top:8px;flex-wrap:wrap}.prompto-custom-icon-input{border:1px solid var(--background-modifier-border);border-radius:6px;padding:4px 8px;font-size:12px;background:var(--background-secondary);color:var(--text-normal);width:130px}.prompto-custom-icon-input:focus{border-color:var(--interactive-accent);outline:none}.prompto-custom-icon-preview{width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:var(--text-accent)}.prompto-custom-icon-preview svg{width:16px;height:16px}.prompto-icon-help{margin-top:6px}.prompto-btn-sm{padding:3px 10px;font-size:11px;border-radius:6px;border:1px solid var(--background-modifier-border);background:var(--background-secondary);color:var(--text-normal);cursor:pointer}.prompto-btn-sm:hover{background:var(--interactive-accent);color:var(--text-on-accent)}.prompto-icon-btn svg{width:16px;height:16px;color:var(--text-muted)}.prompto-form-label-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}.prompto-form-label-row .prompto-form-label{margin-bottom:0}.prompto-btn-optimize{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:5px;border:1px solid var(--interactive-accent);background:var(--interactive-accent);color:var(--text-on-accent);font-size:11px;cursor:pointer;transition:opacity .15s}.prompto-btn-optimize:hover{opacity:.85}.prompto-btn-optimize svg{width:12px;height:12px}.prompto-form-buttons{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding:12px 0 4px;border-top:1px solid var(--background-modifier-border);position:sticky;bottom:0;background:var(--background-primary)}.prompto-manage-modal{max-width:1700px!important;width:97vw!important;overflow:hidden!important}.prompto-manage-modal .modal-content{max-height:90vh;overflow-y:auto;overflow-x:hidden;box-sizing:border-box}.prompto-manage-modal.modal{max-width:1700px!important;width:97vw!important;overflow:hidden!important}.prompto-manage-header{margin-bottom:12px}.prompto-manage-title-row{display:flex;align-items:center;gap:10px;margin-bottom:12px}.prompto-manage-title-row h2{margin:0;font-size:18px}.prompto-manage-filter-bar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}.prompto-manage-search{max-width:400px;padding:6px 10px;border:1px solid var(--background-modifier-border);border-radius:6px;background:var(--background-secondary);color:var(--text-normal);font-size:13px;outline:none}.prompto-manage-search:focus{border-color:var(--interactive-accent)}.prompto-manage-cat-filter{padding:5px 8px;font-size:12px;border-radius:6px}.prompto-manage-bulk-bar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;padding:8px 10px;background:var(--background-secondary);border-radius:6px;min-height:36px}.prompto-manage-selected-count{font-weight:600;font-size:13px;color:var(--text-accent);margin-right:4px}.prompto-manage-table-wrap{overflow-x:hidden;margin-bottom:12px;max-height:65vh;overflow-y:auto;border:1px solid var(--background-modifier-border);border-radius:8px;width:100%}.prompto-manage-table{width:100%;border-collapse:collapse;font-size:13px;table-layout:auto}.prompto-manage-table thead{position:sticky;top:0;z-index:1}.prompto-manage-table th{background:var(--background-secondary);padding:8px 10px;text-align:left;font-weight:600;font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.3px;border-bottom:2px solid var(--background-modifier-border);cursor:pointer;white-space:nowrap;user-select:none;width:1%;white-space:nowrap}.prompto-manage-table th:hover{color:var(--text-normal)}.prompto-manage-th-cb{width:1%;cursor:default}.prompto-sort-indicator{color:var(--text-accent);font-size:10px}.prompto-manage-table td{padding:8px 10px;border-bottom:1px solid var(--background-modifier-border);vertical-align:middle;white-space:nowrap}.prompto-manage-table tbody tr:hover{background:var(--background-modifier-hover)}.prompto-manage-row-selected{background:color-mix(in srgb,var(--interactive-accent) 10%,transparent)!important}.prompto-manage-td-name{display:flex;align-items:center;gap:6px;font-weight:500;white-space:nowrap;width:100%}.prompto-manage-icon{display:flex;flex-shrink:0}.prompto-manage-icon svg{width:14px;height:14px;color:var(--text-accent)}.prompto-manage-stars{font-size:12px;color:var(--text-accent)}.prompto-manage-date{font-size:12px;color:var(--text-faint)}.prompto-manage-actions{display:flex;gap:4px}.prompto-manage-action-visible{opacity:1!important}.prompto-manage-export-bar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;padding:10px 0;border-top:1px solid var(--background-modifier-border)}.prompto-btn-export{font-size:12px;padding:5px 10px}.prompto-btn-danger{background:var(--background-modifier-error-rgb,#e03e3e);color:#fff;border-color:transparent}.prompto-btn-danger:hover{opacity:.9}.prompto-btn-manage{background:var(--background-secondary);color:var(--text-muted);border-color:var(--background-modifier-border)}.prompto-btn-manage:hover{color:var(--text-normal);border-color:var(--interactive-accent)}";
		var styleEl = document.createElement("style");
		styleEl.id = "prompto-styles"; styleEl.textContent = css;
		document.head.appendChild(styleEl);
		var self = this;
		this.register(function() { var e = document.getElementById("prompto-styles"); if (e) e.remove(); });
	}
}

module.exports = PromptoPlugin;
